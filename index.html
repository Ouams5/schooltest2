<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BNI Yekhlef Highschool — Student Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
/* --- CLEAN UI STYLES --- */
:root {
  --bg: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  --surface: #ffffff;
  --surface-secondary: #f8fafc;
  --muted: #64748b;
  --primary: #1e40af;
  --primary-light: #3b82f6;
  --accent: #475569;
  --danger: #ef4444;
  --success: #10b981;
  --warning: #f59e0b;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --radius: 12px;
  --gap: 20px;
  font-family: 'Poppins', system-ui, -apple-system, sans-serif;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  margin: 0;
  padding: 20px;
  background: var(--bg);
  font-family: var(--font);
  display: flex;
  justify-content: center;
  color: var(--primary);
  min-height: 100vh;
}

.app {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: var(--gap);
  width: 100%;
  max-width: 1400px;
}

/* Sidebar */
.sidebar {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
  border: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  height: calc(100vh - 40px);
  position: sticky;
  top: 20px;
}

.brand {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.logo {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 12px;
  color: white;
  font-weight: 700;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.brand .title {
  font-weight: 700;
  font-size: 18px;
  color: var(--primary);
}

.brand .sub {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 4px;
  flex: 1;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  font-weight: 500;
  color: var(--primary);
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.nav-item:hover {
  background: var(--surface-secondary);
  border-color: #e2e8f0;
}

.nav-item.active {
  background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
  border-left: 4px solid var(--primary-light);
  padding-left: 12px;
  color: var(--primary-light);
}

.icon {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  font-size: 20px;
  color: var(--primary);
}

.nav-item.active .icon {
  color: var(--primary-light);
}

.profile-card {
  padding: 16px;
  border-radius: 8px;
  background: var(--surface-secondary);
  border: 1px solid #e2e8f0;
  margin-top: auto;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.profile-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 18px;
}

.profile-info {
  flex: 1;
}

.profile-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 2px;
}

.profile-role {
  font-size: 12px;
  color: var(--muted);
}

/* Main Content */
.main {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
}

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
}

.search {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface);
  border-radius: var(--radius);
  padding: 12px 16px;
  box-shadow: var(--shadow);
  border: 1px solid #e2e8f0;
  flex: 1;
  max-width: 600px;
}

.search input {
  border: 0;
  outline: 0;
  background: transparent;
  width: 100%;
  font-size: 14px;
  color: var(--primary);
}

.top-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.welcome-container {
  text-align: right;
}

.welcome-text {
  font-weight: 600;
  font-size: 15px;
}

.welcome-sub {
  font-size: 12px;
  color: var(--muted);
}

.language-btn {
  padding: 8px 12px;
  border-radius: 8px;
  background: var(--surface);
  border: 1px solid #e2e8f0;
  color: var(--primary);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  transition: all 0.2s;
}

.language-btn:hover {
  background: var(--surface-secondary);
  border-color: var(--primary-light);
}

/* Cards */
.card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid #e2e8f0;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.card-title {
  font-weight: 600;
  font-size: 18px;
  color: var(--primary);
}

/* Buttons */
.btn {
  padding: 10px 16px;
  border-radius: 8px;
  border: 0;
  background: var(--primary);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
}

.btn:hover {
  background: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn.primary {
  background: var(--primary-light);
}

.btn.primary:hover {
  background: #2563eb;
}

.btn.success {
  background: var(--success);
}

.btn.success:hover {
  background: #059669;
}

.btn.ghost {
  background: transparent;
  border: 1px solid #e2e8f0;
  color: var(--primary);
}

.btn.ghost:hover {
  background: var(--surface-secondary);
  border-color: var(--primary-light);
  color: var(--primary-light);
}

/* Forms */
.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: var(--primary);
  font-size: 14px;
}

.form-control {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  background: white;
  font-family: inherit;
  font-size: 14px;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary-light);
}

/* List Items */
.list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  margin-bottom: 8px;
  background: white;
}

/* Club Cards */
.club-card {
  border: 1px solid #e2e8f0;
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  background: white;
}

.club-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 16px;
}

.club-logo {
  width: 64px;
  height: 64px;
  border-radius: 8px;
  background: var(--surface-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
}

.club-info {
  flex: 1;
}

.club-name {
  font-weight: 700;
  font-size: 20px;
  margin: 0 0 4px 0;
  color: var(--primary);
}

.club-leaders {
  font-size: 14px;
  color: var(--accent);
  margin: 0 0 12px 0;
}

.club-description {
  font-size: 14px;
  line-height: 1.5;
  color: var(--primary);
  margin: 0 0 16px 0;
}

/* Toast */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--surface);
  padding: 16px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  min-width: 300px;
  display: flex;
  align-items: center;
  gap: 12px;
  transform: translateX(150%);
  transition: transform 0.3s;
  z-index: 1000;
}

.toast.show {
  transform: translateX(0);
}

.toast.success {
  border-left: 4px solid var(--success);
}

.toast.error {
  border-left: 4px solid var(--danger);
}

.toast.info {
  border-left: 4px solid var(--primary-light);
}

/* Loading */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(59, 130, 246, 0.3);
  border-radius: 50%;
  border-top-color: var(--primary-light);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* Responsive */
@media (max-width: 1024px) {
  .app {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    position: relative;
    height: auto;
    top: 0;
  }
}

@media (max-width: 768px) {
  body {
    padding: 16px;
  }
  
  .topbar {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }
  
  .search {
    max-width: 100%;
  }
  
  .top-actions {
    justify-content: space-between;
  }
}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">BY</div>
      <div>
        <div class="title">BNI Yekhlef Highschool</div>
        <div class="sub">Student Portal</div>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-item active" data-tab="dashboard">
        <span class="material-symbols-outlined icon">dashboard</span>Dashboard
      </div>
      <div class="nav-item" data-tab="projects">
        <span class="material-symbols-outlined icon">work</span>Projects
      </div>
      <div class="nav-item" data-tab="assignments">
        <span class="material-symbols-outlined icon">assignment</span>Assignments
      </div>
      <div class="nav-item" data-tab="clubs">
        <span class="material-symbols-outlined icon">groups</span>Clubs
      </div>
      <div class="nav-item" data-tab="profile">
        <span class="material-symbols-outlined icon">person</span>Profile
      </div>
      <div id="adminNav" class="nav-item" data-tab="admin" style="display:none">
        <span class="material-symbols-outlined icon">admin_panel_settings</span>Admin
      </div>
    </nav>
    
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-avatar" id="sideProfileInitials">GU</div>
        <div class="profile-info">
          <div class="profile-name" id="sideName">Guest User</div>
          <div class="profile-role" id="sideRole">Not signed in</div>
        </div>
      </div>
      <div style="display: flex; gap: 8px;">
        <button id="sidebarLogout" class="btn ghost" style="flex:1; display:none">Logout</button>
        <button id="openLogin" class="btn primary" style="flex:1">Login</button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <!-- Topbar -->
    <div class="topbar">
      <div class="search">
        <span class="material-symbols-outlined" style="color:var(--muted)">search</span>
        <input id="globalSearch" placeholder="Search...">
      </div>
      <div class="top-actions">
        <button class="language-btn" id="languageBtn">
          <span class="material-symbols-outlined">language</span>
          <span>English</span>
        </button>
        <div class="welcome-container">
          <div class="welcome-text" id="welcomeText">Welcome</div>
          <div class="welcome-sub" id="welcomeSub">Please sign in</div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <section id="dashboard" class="card">
      <div class="card-header">
        <h2 class="card-title">Dashboard</h2>
      </div>
      <p>Welcome to BNI Yekhlef Student Portal. Select a section from the sidebar to get started.</p>
    </section>
    
    <!-- Projects -->
    <section id="projects" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Projects</h2>
        <button id="createProjectBtn" class="btn primary">Create Project</button>
      </div>
      <div id="projectsList">No projects yet</div>
    </section>
    
    <!-- Assignments -->
    <section id="assignments" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Assignments</h2>
      </div>
      <div id="assignmentsList">No assignments yet</div>
    </section>
    
    <!-- Clubs -->
    <section id="clubs" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Clubs</h2>
        <button id="createClubBtn" class="btn primary">Create Club</button>
      </div>
      <div id="clubsList">Loading clubs...</div>
    </section>
    
    <!-- Profile -->
    <section id="profile" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">My Profile</h2>
        <button id="saveProfileBtn" class="btn success">Save Profile</button>
      </div>
      <div style="max-width: 500px;">
        <div class="form-group" style="display:flex; gap:24px; align-items:flex-start;">
          <div style="position:relative">
            <div class="profile-avatar" id="profileAvatarFallback" style="width:100px;height:100px;font-size:32px">GU</div>
          </div>
          <div style="flex:1">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" id="profileName" class="form-control" placeholder="Your Full Name">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="profileEmail" class="form-control" disabled>
              </div>
              <div class="form-group">
                <label class="form-label">Grade</label>
                <select id="profileGrade" class="form-control">
                  <option value="">Select Grade</option>
                  <option value="TC">TC</option>
                  <option value="1BAC">1BAC</option>
                  <option value="2BAC">2BAC</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Bio</label>
          <textarea id="profileBio" class="form-control" placeholder="Tell us about yourself..." rows="4"></textarea>
        </div>
      </div>
    </section>
    
    <!-- Admin -->
    <section id="admin" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Admin Panel</h2>
      </div>
      <div id="adminContent"></div>
    </section>
  </main>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Auth Modal -->
<div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1000;">
  <div style="background:var(--surface);padding:24px;border-radius:var(--radius);max-width:400px;width:90%;">
    <h3 style="margin-bottom:20px;">Sign in / Register</h3>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <input id="modalFirstName" placeholder="First Name" class="form-control">
        <input id="modalLastName" placeholder="Last Name" class="form-control">
      </div>
      <input id="modalEmail" type="email" placeholder="Email" class="form-control">
      <input id="modalPass" type="password" placeholder="Password" class="form-control">
      <select id="modalGrade" class="form-control">
        <option value="">Select Grade</option>
        <option value="TC">TC</option>
        <option value="1BAC">1BAC</option>
        <option value="2BAC">2BAC</option>
      </select>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="modalCancel" class="btn ghost">Cancel</button>
        <button id="modalRegister" class="btn ghost">Register</button>
        <button id="modalLogin" class="btn primary">Login</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
// =============================================
// SIMPLE WORKING VERSION - BNI YEKHELF PORTAL
// =============================================

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBcvybNF9Hn89jb2zRQxknb6l0uMeiS-EM",
  authDomain: "school-bni-yekhlef-id.firebaseapp.com",
  projectId: "bniyekhlef-high-school",
  storageBucket: "school-bni-yekhlef-id",
  messagingSenderId: "893030570286",
  appId: "1:893030570286:web:bec5df8427b532f5e202bf",
  measurementId: "G-4V7JRRR48W"
};

// Initialize Firebase
try {
  firebase.initializeApp(firebaseConfig);
} catch (err) {
  console.error('Firebase error:', err);
}

const auth = firebase.auth();
const db = firebase.firestore();

// Simple State
let currentUser = null;
let userData = null;
let currentLanguage = 'en';

// Translations
const translations = {
  en: {
    welcome: "Welcome",
    pleaseSignIn: "Please sign in",
    dashboard: "Dashboard",
    projects: "Projects",
    assignments: "Assignments",
    clubs: "Clubs",
    profile: "Profile",
    admin: "Admin",
    login: "Login",
    logout: "Logout",
    search: "Search...",
    noProjects: "No projects yet",
    noAssignments: "No assignments yet",
    loadingClubs: "Loading clubs...",
    save: "Save",
    cancel: "Cancel",
    create: "Create"
  },
  fr: {
    welcome: "Bienvenue",
    pleaseSignIn: "Veuillez vous connecter",
    dashboard: "Tableau de bord",
    projects: "Projets",
    assignments: "Devoirs",
    clubs: "Clubs",
    profile: "Profil",
    admin: "Administration",
    login: "Connexion",
    logout: "Déconnexion",
    search: "Rechercher...",
    noProjects: "Aucun projet pour le moment",
    noAssignments: "Aucun devoir pour le moment",
    loadingClubs: "Chargement des clubs...",
    save: "Enregistrer",
    cancel: "Annuler",
    create: "Créer"
  },
  ar: {
    welcome: "مرحباً",
    pleaseSignIn: "يرجى تسجيل الدخول",
    dashboard: "لوحة التحكم",
    projects: "المشاريع",
    assignments: "الواجبات",
    clubs: "الأندية",
    profile: "الملف الشخصي",
    admin: "الإدارة",
    login: "تسجيل الدخول",
    logout: "تسجيل الخروج",
    search: "بحث...",
    noProjects: "لا توجد مشاريع بعد",
    noAssignments: "لا توجد واجبات بعد",
    loadingClubs: "جاري تحميل الأندية...",
    save: "حفظ",
    cancel: "إلغاء",
    create: "إنشاء"
  }
};

// Simple Toast System
function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// Set Loading State
function setLoading(button, isLoading) {
  if (isLoading) {
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>';
  } else {
    button.disabled = false;
    button.innerHTML = button.getAttribute('data-original-text') || button.textContent;
  }
}

// Get Initials from Name
function getInitials(name) {
  if (!name) return 'GU';
  return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

// Update Language
function updateLanguage(lang) {
  currentLanguage = lang;
  localStorage.setItem('portal_language', lang);
  
  const t = translations[lang];
  const langBtn = document.getElementById('languageBtn');
  if (langBtn) {
    langBtn.querySelector('span:last-child').textContent = 
      lang === 'en' ? 'English' : lang === 'fr' ? 'Français' : 'العربية';
  }
  
  // Update search placeholder
  const search = document.getElementById('globalSearch');
  if (search) search.placeholder = t.search;
  
  // Update navigation
  const navItems = document.querySelectorAll('.nav-item');
  const navTexts = ['dashboard', 'projects', 'assignments', 'clubs', 'profile', 'admin'];
  navItems.forEach((item, index) => {
    const icon = item.querySelector('.icon');
    if (icon && t[navTexts[index]]) {
      item.innerHTML = icon.outerHTML + t[navTexts[index]];
    }
  });
  
  // Update buttons
  const buttons = {
    'openLogin': t.login,
    'sidebarLogout': t.logout,
    'saveProfileBtn': t.save,
    'modalCancel': t.cancel,
    'modalRegister': t.create,
    'modalLogin': t.login
  };
  
  Object.keys(buttons).forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.textContent = buttons[id];
  });
}

// Initialize UI
function initUI() {
  // Navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      const tab = item.dataset.tab;
      
      // Hide all sections
      document.querySelectorAll('main section').forEach(sec => {
        sec.style.display = 'none';
      });
      
      // Show selected section
      document.getElementById(tab).style.display = 'block';
      
      // Update active state
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      
      // Load data for section
      loadSectionData(tab);
    });
  });
  
  // Auth Modal
  document.getElementById('openLogin').addEventListener('click', () => {
    document.getElementById('authModal').style.display = 'flex';
  });
  
  document.getElementById('modalCancel').addEventListener('click', () => {
    document.getElementById('authModal').style.display = 'none';
  });
  
  document.getElementById('authModal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      document.getElementById('authModal').style.display = 'none';
    }
  });
  
  // Login
  document.getElementById('modalLogin').addEventListener('click', async () => {
    const email = document.getElementById('modalEmail').value;
    const password = document.getElementById('modalPass').value;
    
    if (!email || !password) {
      showToast('Please enter email and password', 'error');
      return;
    }
    
    const button = document.getElementById('modalLogin');
    button.setAttribute('data-original-text', button.textContent);
    setLoading(button, true);
    
    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      showToast('Logged in successfully!', 'success');
      document.getElementById('authModal').style.display = 'none';
      
      // Clear form
      document.getElementById('modalEmail').value = '';
      document.getElementById('modalPass').value = '';
      document.getElementById('modalFirstName').value = '';
      document.getElementById('modalLastName').value = '';
      document.getElementById('modalGrade').value = '';
    } catch (error) {
      console.error('Login error:', error);
      showToast('Login failed: ' + error.message, 'error');
    } finally {
      setLoading(button, false);
    }
  });
  
  // Register
  document.getElementById('modalRegister').addEventListener('click', async () => {
    const firstName = document.getElementById('modalFirstName').value;
    const lastName = document.getElementById('modalLastName').value;
    const email = document.getElementById('modalEmail').value;
    const password = document.getElementById('modalPass').value;
    const grade = document.getElementById('modalGrade').value;
    
    if (!firstName || !lastName || !email || !password || !grade) {
      showToast('Please fill all fields', 'error');
      return;
    }
    
    const button = document.getElementById('modalRegister');
    button.setAttribute('data-original-text', button.textContent);
    setLoading(button, true);
    
    try {
      // Create user
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      
      // Create user document
      await db.collection('users').doc(userCredential.user.uid).set({
        uid: userCredential.user.uid,
        email: email,
        name: `${firstName} ${lastName}`,
        firstName: firstName,
        lastName: lastName,
        grade: grade,
        role: 'student',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      showToast('Account created successfully!', 'success');
      document.getElementById('authModal').style.display = 'none';
      
      // Clear form
      document.getElementById('modalEmail').value = '';
      document.getElementById('modalPass').value = '';
      document.getElementById('modalFirstName').value = '';
      document.getElementById('modalLastName').value = '';
      document.getElementById('modalGrade').value = '';
    } catch (error) {
      console.error('Register error:', error);
      showToast('Registration failed: ' + error.message, 'error');
    } finally {
      setLoading(button, false);
    }
  });
  
  // Logout
  document.getElementById('sidebarLogout').addEventListener('click', () => {
    auth.signOut();
    showToast('Logged out', 'info');
  });
  
  // Create Project
  document.getElementById('createProjectBtn').addEventListener('click', async () => {
    if (!currentUser) {
      showToast('Please login first', 'error');
      return;
    }
    
    const title = prompt('Enter project title:');
    if (!title) return;
    
    const description = prompt('Enter project description:');
    
    try {
      await db.collection('projects').add({
        title: title,
        description: description || '',
        createdBy: currentUser.uid,
        creatorEmail: currentUser.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'active'
      });
      
      showToast('Project created!', 'success');
      loadProjects();
    } catch (error) {
      showToast('Failed to create project', 'error');
    }
  });
  
  // Create Club
  document.getElementById('createClubBtn').addEventListener('click', async () => {
    if (!currentUser) {
      showToast('Please login first', 'error');
      return;
    }
    
    const name = prompt('Enter club name:');
    if (!name) return;
    
    const abbreviation = prompt('Enter club abbreviation (2-4 letters):');
    const leader1 = prompt('Enter primary leader name:');
    const description = prompt('Enter club description:');
    
    if (!name || !abbreviation || !leader1 || !description) {
      showToast('All fields are required', 'error');
      return;
    }
    
    try {
      await db.collection('clubs').add({
        name: name,
        abbreviation: abbreviation,
        description: description,
        leader1: leader1,
        createdBy: currentUser.uid,
        creatorEmail: currentUser.email,
        members: [currentUser.uid],
        memberCount: 1,
        funds: 0,
        projects: [],
        events: [],
        status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      showToast('Club created!', 'success');
      loadClubs();
    } catch (error) {
      showToast('Failed to create club', 'error');
    }
  });
  
  // Save Profile
  document.getElementById('saveProfileBtn').addEventListener('click', async () => {
    if (!currentUser) {
      showToast('Please login first', 'error');
      return;
    }
    
    const name = document.getElementById('profileName').value;
    const grade = document.getElementById('profileGrade').value;
    const bio = document.getElementById('profileBio').value;
    
    if (!name) {
      showToast('Name is required', 'error');
      return;
    }
    
    const button = document.getElementById('saveProfileBtn');
    button.setAttribute('data-original-text', button.textContent);
    setLoading(button, true);
    
    try {
      await db.collection('users').doc(currentUser.uid).update({
        name: name,
        grade: grade,
        bio: bio,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      showToast('Profile saved!', 'success');
      
      // Update UI
      userData = { ...userData, name, grade, bio };
      updateUIForUser();
    } catch (error) {
      showToast('Failed to save profile', 'error');
    } finally {
      setLoading(button, false);
    }
  });
  
  // Language Switcher
  document.getElementById('languageBtn').addEventListener('click', () => {
    const languages = ['en', 'fr', 'ar'];
    const currentIndex = languages.indexOf(currentLanguage);
    const nextIndex = (currentIndex + 1) % languages.length;
    updateLanguage(languages[nextIndex]);
  });
}

// Update UI for user
function updateUIForUser() {
  const t = translations[currentLanguage];
  
  if (currentUser && userData) {
    const initials = getInitials(userData.name || userData.email);
    
    // Update sidebar
    document.getElementById('sideName').textContent = userData.name || userData.email;
    document.getElementById('sideRole').textContent = userData.role === 'admin' ? 'Administrator' : 'Student';
    document.getElementById('sideProfileInitials').textContent = initials;
    document.getElementById('profileAvatarFallback').textContent = initials;
    
    // Update topbar
    document.getElementById('welcomeText').textContent = t.welcome + ', ' + (userData.firstName || userData.name || 'User');
    document.getElementById('welcomeSub').textContent = userData.role === 'admin' ? 'Administrator Dashboard' : 'Student Dashboard';
    
    // Show/hide admin
    document.getElementById('adminNav').style.display = userData.role === 'admin' ? 'block' : 'none';
    
    // Update login/logout
    document.getElementById('openLogin').style.display = 'none';
    document.getElementById('sidebarLogout').style.display = 'block';
    
    // Update profile form
    document.getElementById('profileName').value = userData.name || '';
    document.getElementById('profileEmail').value = userData.email || '';
    document.getElementById('profileGrade').value = userData.grade || '';
    document.getElementById('profileBio').value = userData.bio || '';
  } else {
    // Guest user
    document.getElementById('sideName').textContent = 'Guest User';
    document.getElementById('sideRole').textContent = 'Not signed in';
    document.getElementById('sideProfileInitials').textContent = 'GU';
    document.getElementById('profileAvatarFallback').textContent = 'GU';
    
    document.getElementById('welcomeText').textContent = t.welcome;
    document.getElementById('welcomeSub').textContent = t.pleaseSignIn;
    
    document.getElementById('adminNav').style.display = 'none';
    document.getElementById('openLogin').style.display = 'block';
    document.getElementById('sidebarLogout').style.display = 'none';
    
    document.getElementById('profileName').value = '';
    document.getElementById('profileEmail').value = '';
    document.getElementById('profileGrade').value = '';
    document.getElementById('profileBio').value = '';
  }
}

// Load section data
async function loadSectionData(section) {
  if (!currentUser) return;
  
  switch(section) {
    case 'projects':
      await loadProjects();
      break;
    case 'clubs':
      await loadClubs();
      break;
    case 'admin':
      await loadAdminData();
      break;
  }
}

// Load projects
async function loadProjects() {
  try {
    const snapshot = await db.collection('projects')
      .where('createdBy', '==', currentUser.uid)
      .get();
    
    const projectsList = document.getElementById('projectsList');
    
    if (snapshot.empty) {
      projectsList.innerHTML = '<div class="list-item">No projects yet. Create one!</div>';
      return;
    }
    
    projectsList.innerHTML = snapshot.docs.map(doc => {
      const data = doc.data();
      return `
        <div class="list-item">
          <div>
            <strong>${data.title}</strong>
            <div style="font-size:14px;color:var(--muted);margin-top:4px">${data.description}</div>
          </div>
          <div style="font-size:12px;color:var(--muted)">
            ${data.createdAt ? data.createdAt.toDate().toLocaleDateString() : 'Recently'}
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Error loading projects:', error);
  }
}

// Load clubs
async function loadClubs() {
  try {
    const snapshot = await db.collection('clubs').get();
    const clubsList = document.getElementById('clubsList');
    
    if (snapshot.empty) {
      clubsList.innerHTML = '<div class="club-card">No clubs yet</div>';
      return;
    }
    
    clubsList.innerHTML = snapshot.docs.map(doc => {
      const data = doc.data();
      const isMember = data.members && data.members.includes(currentUser.uid);
      
      return `
        <div class="club-card">
          <div class="club-header">
            <div class="club-logo">
              <span class="material-symbols-outlined">groups</span>
            </div>
            <div class="club-info">
              <h3 class="club-name">${data.name}</h3>
              <p class="club-leaders">Leaders: ${data.leader1}</p>
              <p class="club-description">${data.description}</p>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px">
            ${isMember ? 
              '<button class="btn success" style="font-size:12px;padding:6px 12px">Already Joined</button>' : 
              `<button class="btn primary" style="font-size:12px;padding:6px 12px" onclick="joinClub('${doc.id}')">Join Club</button>`
            }
          </div>
        </div>
      `;
    }).join('');
  } catch (error) {
    console.error('Error loading clubs:', error);
  }
}

// Join club
async function joinClub(clubId) {
  if (!currentUser) return;
  
  try {
    const clubRef = db.collection('clubs').doc(clubId);
    const clubDoc = await clubRef.get();
    
    if (clubDoc.exists) {
      const data = clubDoc.data();
      const members = data.members || [];
      
      if (members.includes(currentUser.uid)) {
        showToast('Already a member', 'info');
        return;
      }
      
      members.push(currentUser.uid);
      
      await clubRef.update({
        members: members,
        memberCount: members.length
      });
      
      showToast('Joined club!', 'success');
      loadClubs();
    }
  } catch (error) {
    showToast('Failed to join club', 'error');
  }
}

// Load admin data
async function loadAdminData() {
  if (!currentUser || userData.role !== 'admin') return;
  
  try {
    const snapshot = await db.collection('users').get();
    const adminContent = document.getElementById('adminContent');
    
    let html = '<h3>Users</h3>';
    
    if (snapshot.empty) {
      html += '<p>No users found</p>';
    } else {
      html += '<div style="display:grid;gap:8px;margin-top:16px">';
      
      snapshot.docs.forEach(doc => {
        const user = doc.data();
        html += `
          <div class="list-item">
            <div>
              <strong>${user.name || user.email}</strong>
              <div style="font-size:12px;color:var(--muted)">${user.email} • ${user.grade || 'No grade'}</div>
            </div>
            <div style="font-size:12px;color:var(--muted)">${user.role || 'student'}</div>
          </div>
        `;
      });
      
      html += '</div>';
    }
    
    adminContent.innerHTML = html;
  } catch (error) {
    console.error('Error loading admin data:', error);
  }
}

// Initialize everything
document.addEventListener('DOMContentLoaded', () => {
  // Initialize UI
  initUI();
  
  // Load saved language
  const savedLang = localStorage.getItem('portal_language') || 'en';
  updateLanguage(savedLang);
  
  // Auth state listener
  auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    
    if (user) {
      // Get user data
      try {
        const doc = await db.collection('users').doc(user.uid).get();
        if (doc.exists) {
          userData = doc.data();
        } else {
          // Create user document if doesn't exist
          userData = {
            uid: user.uid,
            email: user.email,
            name: user.email.split('@')[0],
            role: 'student',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          await db.collection('users').doc(user.uid).set(userData);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    } else {
      userData = null;
    }
    
    updateUIForUser();
    
    // Load initial data if logged in
    if (user) {
      loadProjects();
      loadClubs();
    }
  });
  
  // Show welcome message
  setTimeout(() => {
    showToast('Welcome to BNI Yekhlef Student Portal!', 'info');
  }, 1000);
});
</script>
</body>
</html>
