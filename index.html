<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Student Portal — Enhanced Classroom UI</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
/* --- ENHANCED UI STYLES --- */
:root {
  --bg: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  --surface: #ffffff;
  --surface-secondary: #f8fafc;
  --muted: #64748b;
  --primary: #0f172a;
  --primary-light: #3b82f6;
  --accent: #475569;
  --danger: #ef4444;
  --success: #10b981;
  --warning: #f59e0b;
  --info: #3b82f6;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --radius: 12px;
  --radius-sm: 8px;
  --maxWidth: 1400px;
  --gap: 20px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  margin: 0;
  padding: 24px;
  background: var(--bg);
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  display: flex;
  justify-content: center;
  color: var(--primary);
  min-height: 100vh;
}

.app {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: var(--gap);
  width: 100%;
  max-width: var(--maxWidth);
  align-items: start;
}

/* Enhanced Sidebar */
.sidebar {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow-lg);
  position: sticky;
  top: 24px;
  height: calc(100vh - 48px);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  border: 1px solid #e2e8f0;
}

.sidebar-content {
  flex: 1;
  overflow-y: auto;
}

.sidebar-footer {
  padding-top: 16px;
  border-top: 1px solid #e2e8f0;
}

.brand {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.logo {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  border-radius: 12px;
  color: white;
  font-weight: 700;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow);
}

.brand .title {
  font-weight: 700;
  font-size: 18px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.brand .sub {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 20px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: var(--radius-sm);
  font-weight: 500;
  color: var(--primary);
  cursor: pointer;
  transition: var(--transition);
  border: 1px solid transparent;
}

.nav-item:hover {
  background: var(--surface-secondary);
  border-color: #e2e8f0;
  transform: translateX(4px);
}

.nav-item.active {
  background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
  border-left: 4px solid var(--primary-light);
  padding-left: 12px;
  color: var(--primary-light);
}

.nav-item.active .icon {
  color: var(--primary-light);
}

.nav-item .badge {
  margin-left: auto;
  background: var(--primary-light);
  color: white;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 12px;
}

.icon {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  font-size: 20px;
  color: var(--primary);
}

.profile-card {
  padding: 16px;
  border-radius: var(--radius-sm);
  background: linear-gradient(135deg, var(--surface-secondary), #fff);
  border: 1px solid #e2e8f0;
  margin-bottom: 20px;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.profile-avatar {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--primary-light);
}

.profile-info {
  flex: 1;
}

.profile-name {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 2px;
}

.profile-role {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.profile-stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-top: 12px;
}

.profile-stat {
  text-align: center;
  padding: 8px;
  background: white;
  border-radius: var(--radius-sm);
  border: 1px solid #e2e8f0;
}

.profile-stat-value {
  font-weight: 700;
  color: var(--primary);
  font-size: 14px;
}

.profile-stat-label {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
}

/* Enhanced Main Content */
.main {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
}

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
}

.search-container {
  flex: 1;
  max-width: 600px;
}

.search {
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface);
  border-radius: var(--radius);
  padding: 12px 16px;
  box-shadow: var(--shadow);
  border: 1px solid transparent;
  transition: var(--transition);
}

.search:focus-within {
  border-color: var(--primary-light);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search input {
  border: 0;
  outline: 0;
  background: transparent;
  width: 100%;
  font-size: 14px;
  color: var(--primary);
}

.search input::placeholder {
  color: var(--muted);
}

.top-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.welcome-container {
  text-align: right;
}

.welcome-text {
  font-weight: 600;
  font-size: 15px;
}

.welcome-sub {
  font-size: 12px;
  color: var(--muted);
}

.notification-bell {
  position: relative;
  cursor: pointer;
  padding: 8px;
  border-radius: var(--radius-sm);
  transition: var(--transition);
}

.notification-bell:hover {
  background: var(--surface-secondary);
}

.notification-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  background: var(--danger);
  color: white;
  font-size: 10px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Enhanced Cards */
.card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid #e2e8f0;
  transition: var(--transition);
}

.card:hover {
  box-shadow: var(--shadow-lg);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.card-title {
  font-weight: 600;
  font-size: 18px;
  color: var(--primary);
}

.card-actions {
  display: flex;
  gap: 8px;
}

/* Enhanced Grid */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

/* Enhanced List Items */
.list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-radius: var(--radius-sm);
  border: 1px solid #e2e8f0;
  margin-bottom: 8px;
  background: #fff;
  transition: var(--transition);
}

.list-item:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.list-item-content {
  flex: 1;
}

.list-item-title {
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--primary);
}

.list-item-subtitle {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 8px;
}

.list-item-meta {
  display: flex;
  gap: 12px;
  font-size: 12px;
  color: var(--muted);
}

.list-item-actions {
  display: flex;
  gap: 8px;
}

/* Enhanced Chat */
.chat-area {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.chat-window {
  height: 400px;
  border-radius: var(--radius);
  border: 1px solid #e2e8f0;
  padding: 16px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background: #f8fbff;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding-right: 8px;
}

.message {
  padding: 12px;
  border-radius: var(--radius-sm);
  background: white;
  margin-bottom: 12px;
  border: 1px solid #e2e8f0;
  max-width: 80%;
}

.message.sent {
  margin-left: auto;
  background: linear-gradient(135deg, var(--primary-light), #2563eb);
  color: white;
  border: none;
}

.message .meta {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.message.sent .meta {
  color: rgba(255, 255, 255, 0.9);
}

.message-sender {
  font-weight: 600;
}

.message-time {
  font-size: 11px;
}

.message-text {
  line-height: 1.5;
}

.chat-input-container {
  display: flex;
  gap: 12px;
  align-items: center;
}

.chat-input {
  flex: 1;
  padding: 14px;
  border-radius: var(--radius);
  border: 1px solid #e2e8f0;
  background: #ffffff;
  font-family: inherit;
  font-size: 14px;
  transition: var(--transition);
}

.chat-input:focus {
  outline: none;
  border-color: var(--primary-light);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Enhanced Buttons */
.btn {
  padding: 10px 16px;
  border-radius: var(--radius-sm);
  border: 0;
  background: var(--primary);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
}

.btn:hover {
  background: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.btn:active {
  transform: translateY(0);
}

.btn.primary {
  background: var(--primary-light);
}

.btn.primary:hover {
  background: #2563eb;
}

.btn.success {
  background: var(--success);
}

.btn.success:hover {
  background: #059669;
}

.btn.warning {
  background: var(--warning);
}

.btn.warning:hover {
  background: #d97706;
}

.btn.danger {
  background: var(--danger);
}

.btn.danger:hover {
  background: #dc2626;
}

.btn.ghost {
  background: transparent;
  border: 1px solid #e2e8f0;
  color: var(--primary);
}

.btn.ghost:hover {
  background: var(--surface-secondary);
  border-color: var(--primary-light);
  color: var(--primary-light);
}

.btn.sm {
  padding: 6px 12px;
  font-size: 12px;
}

.btn.lg {
  padding: 14px 24px;
  font-size: 16px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-icon {
  width: 36px;
  height: 36px;
  padding: 0;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Enhanced Modals */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.7);
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(4px);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal {
  background: var(--surface);
  padding: 32px;
  border-radius: var(--radius);
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.modal-title {
  font-weight: 600;
  font-size: 20px;
  color: var(--primary);
}

.modal-close {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: var(--radius-sm);
  transition: var(--transition);
}

.modal-close:hover {
  background: var(--surface-secondary);
}

.modal-body {
  margin-bottom: 24px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding-top: 16px;
  border-top: 1px solid #e2e8f0;
}

/* Enhanced Forms */
.form-group {
  margin-bottom: 16px;
}

.form-label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: var(--primary);
  font-size: 14px;
}

.form-control {
  width: 100%;
  padding: 12px;
  border-radius: var(--radius-sm);
  border: 1px solid #e2e8f0;
  background: white;
  font-family: inherit;
  font-size: 14px;
  transition: var(--transition);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary-light);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control.error {
  border-color: var(--danger);
}

.form-error {
  color: var(--danger);
  font-size: 12px;
  margin-top: 4px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
  padding-right: 36px;
}

/* Enhanced Toast */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  background: var(--surface);
  padding: 16px;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-lg);
  min-width: 300px;
  max-width: 400px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
  transform: translateX(150%);
  transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  border-left: 4px solid transparent;
}

.toast.show {
  transform: translateX(0);
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--danger);
}

.toast.warning {
  border-left-color: var(--warning);
}

.toast.info {
  border-left-color: var(--info);
}

.toast-icon {
  font-size: 20px;
}

.toast-success .toast-icon {
  color: var(--success);
}

.toast-error .toast-icon {
  color: var(--danger);
}

.toast-warning .toast-icon {
  color: var(--warning);
}

.toast-info .toast-icon {
  color: var(--info);
}

.toast-content {
  flex: 1;
}

.toast-title {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 4px;
}

.toast-message {
  font-size: 13px;
  color: var(--muted);
  line-height: 1.4;
}

.toast-close {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 2px;
  border-radius: 4px;
  color: var(--muted);
  transition: var(--transition);
}

.toast-close:hover {
  color: var(--primary);
  background: var(--surface-secondary);
}

/* Enhanced Loading */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(59, 130, 246, 0.3);
  border-radius: 50%;
  border-top-color: var(--primary-light);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1002;
  backdrop-filter: blur(4px);
}

.loading-overlay.show {
  display: flex;
}

.loading-content {
  text-align: center;
}

.loading-spinner {
  width: 48px;
  height: 48px;
  border: 4px solid rgba(59, 130, 246, 0.3);
  border-radius: 50%;
  border-top-color: var(--primary-light);
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}

/* Enhanced Profile */
.profile-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 500px;
}

.profile-avatar-upload {
  position: relative;
  width: 100px;
  height: 100px;
}

.profile-avatar-upload img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--primary-light);
}

.profile-avatar-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: var(--transition);
  cursor: pointer;
}

.profile-avatar-upload:hover .profile-avatar-overlay {
  opacity: 1;
}

.profile-avatar-overlay span {
  color: white;
  font-size: 24px;
}

/* Enhanced Admin */
.admin-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.admin-table-container {
  overflow-x: auto;
  border-radius: var(--radius-sm);
  border: 1px solid #e2e8f0;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
}

.admin-table th {
  background: var(--surface-secondary);
  font-weight: 600;
  text-align: left;
  padding: 16px;
  border-bottom: 2px solid #e2e8f0;
  color: var(--primary);
}

.admin-table td {
  padding: 16px;
  border-bottom: 1px solid #e2e8f0;
}

.admin-table tr:hover {
  background: var(--surface-secondary);
}

/* Enhanced Club System */
.club-card {
  border: 1px solid #e2e8f0;
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  background: white;
  transition: var(--transition);
}

.club-card:hover {
  border-color: var(--primary-light);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.club-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 16px;
}

.club-logo {
  width: 64px;
  height: 64px;
  border-radius: var(--radius-sm);
  object-fit: cover;
  border: 2px solid #e2e8f0;
  background: var(--surface-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
}

.club-logo span {
  font-size: 32px;
  color: var(--muted);
}

.club-info {
  flex: 1;
}

.club-name {
  font-weight: 700;
  font-size: 20px;
  margin: 0 0 4px 0;
  color: var(--primary);
}

.club-abbr {
  font-size: 14px;
  color: var(--muted);
  margin: 0 0 8px 0;
  font-weight: 500;
}

.club-leaders {
  font-size: 14px;
  color: var(--accent);
  margin: 0 0 12px 0;
}

.club-description {
  font-size: 14px;
  line-height: 1.5;
  color: var(--primary);
  margin: 0 0 16px 0;
}

.club-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-top: 16px;
}

.club-stat {
  text-align: center;
  padding: 12px;
  background: var(--surface-secondary);
  border-radius: var(--radius-sm);
  border: 1px solid #e2e8f0;
}

.club-stat-value {
  font-weight: 700;
  font-size: 20px;
  color: var(--primary);
  margin-bottom: 4px;
}

.club-stat-label {
  font-size: 12px;
  color: var(--muted);
  font-weight: 500;
}

.club-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

/* Role Badges */
.role-badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.role-admin {
  background: linear-gradient(135deg, #fef2f2, #fee2e2);
  color: #dc2626;
  border: 1px solid #fecaca;
}

.role-leader {
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  color: #d97706;
  border: 1px solid #fde68a;
}

.role-student {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  color: #2563eb;
  border: 1px solid #bfdbfe;
}

.role-owner {
  background: linear-gradient(135deg, #f5f3ff, #ede9fe);
  color: #7c3aed;
  border: 1px solid #ddd6fe;
}

/* Status Badges */
.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.status-active {
  background: #d1fae5;
  color: #065f46;
}

.status-pending {
  background: #fef3c7;
  color: #92400e;
}

.status-inactive {
  background: #f3f4f6;
  color: #374151;
}

/* Dashboard Widgets */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.dashboard-widget {
  background: white;
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid #e2e8f0;
  transition: var(--transition);
}

.dashboard-widget:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.widget-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.widget-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--surface-secondary);
  color: var(--primary-light);
}

.widget-title {
  font-weight: 600;
  font-size: 16px;
  color: var(--primary);
}

.widget-value {
  font-weight: 700;
  font-size: 32px;
  color: var(--primary);
  margin-bottom: 8px;
}

.widget-trend {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 500;
}

.widget-trend.up {
  color: var(--success);
}

.widget-trend.down {
  color: var(--danger);
}

/* Calendar */
.calendar {
  background: white;
  border-radius: var(--radius);
  border: 1px solid #e2e8f0;
  padding: 20px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.calendar-day {
  text-align: center;
  font-weight: 600;
  color: var(--muted);
  padding: 8px;
  font-size: 12px;
}

.calendar-date {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  cursor: pointer;
  transition: var(--transition);
}

.calendar-date:hover {
  background: var(--surface-secondary);
}

.calendar-date.today {
  background: var(--primary-light);
  color: white;
}

.calendar-date.event {
  position: relative;
}

.calendar-date.event::after {
  content: '';
  position: absolute;
  bottom: 4px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--primary-light);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .app {
    grid-template-columns: 1fr;
    padding-bottom: 80px;
  }
  
  .sidebar {
    position: relative;
    height: auto;
    top: 0;
  }
  
  .sidebar-content {
    max-height: 400px;
  }
  
  .search-container {
    max-width: 100%;
  }
  
  .dashboard-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  body {
    padding: 16px;
  }
  
  .card {
    padding: 20px;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .club-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .top-actions {
    flex-direction: column;
    align-items: flex-end;
  }
  
  .club-header {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  
  .club-logo {
    width: 80px;
    height: 80px;
  }
  
  .modal {
    padding: 20px;
    width: 95%;
  }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
  :root {
    --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    --surface: #1e293b;
    --surface-secondary: #334155;
    --muted: #94a3b8;
    --primary: #f1f5f9;
    --primary-light: #60a5fa;
    --accent: #cbd5e1;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
  }
  
  body {
    color: var(--primary);
  }
  
  .search {
    background: var(--surface-secondary);
  }
  
  .list-item {
    background: var(--surface-secondary);
  }
  
  .club-card {
    background: var(--surface-secondary);
  }
  
  .club-stat {
    background: var(--surface);
  }
  
  .dashboard-widget {
    background: var(--surface-secondary);
  }
  
  .calendar {
    background: var(--surface-secondary);
  }
  
  .admin-table th {
    background: var(--surface);
  }
}

/* Accessibility Improvements */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.focus-visible {
  outline: 2px solid var(--primary-light);
  outline-offset: 2px;
}

/* Print Styles */
@media print {
  .sidebar,
  .top-actions,
  .btn,
  .chat-input-container {
    display: none !important;
  }
  
  .app {
    grid-template-columns: 1fr;
  }
  
  .card {
    box-shadow: none;
    border: 1px solid #000;
  }
}
</style>
</head>
<body>
<div class="app">
  <!-- Enhanced Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-content">
      <div class="brand">
        <div class="logo">SP</div>
        <div>
          <div class="title">Student Portal</div>
          <div class="sub">Enhanced Classroom UI</div>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-item active" data-tab="dashboard" tabindex="0">
          <span class="material-symbols-outlined icon">dashboard</span>Dashboard
          <span class="badge" id="dashboardBadge">3</span>
        </div>
        <div class="nav-item" data-tab="projects" tabindex="0">
          <span class="material-symbols-outlined icon">work</span>Projects
        </div>
        <div class="nav-item" data-tab="assignments" tabindex="0">
          <span class="material-symbols-outlined icon">assignment</span>Assignments
          <span class="badge" id="assignmentsBadge">2</span>
        </div>
        <div class="nav-item" data-tab="events" tabindex="0">
          <span class="material-symbols-outlined icon">event</span>Events
        </div>
        <div id="conversationsNav" class="nav-item admin-only" data-tab="conversations" tabindex="0">
          <span class="material-symbols-outlined icon">chat_bubble</span>Conversations
        </div>
        <div class="nav-item" data-tab="clubs" tabindex="0">
          <span class="material-symbols-outlined icon">groups</span>Clubs
        </div>
        <div class="nav-item" data-tab="reports" tabindex="0">
          <span class="material-symbols-outlined icon">analytics</span>Reports
        </div>
        <div class="nav-item" data-tab="profile" tabindex="0">
          <span class="material-symbols-outlined icon">person</span>Profile
        </div>
        <div id="adminNav" class="nav-item admin-only" data-tab="admin" tabindex="0">
          <span class="material-symbols-outlined icon">admin_panel_settings</span>Admin Panel
        </div>
        <!-- Club tabs will be dynamically added here -->
      </nav>
      
      <div class="profile-card">
        <div class="profile-header">
          <img id="sideProfilePic" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop&crop=face" class="profile-avatar" alt="Profile">
          <div class="profile-info">
            <div class="profile-name" id="sideName">Guest User</div>
            <div class="profile-role" id="sideRole">Not signed in</div>
          </div>
        </div>
        <div class="profile-stats">
          <div class="profile-stat">
            <div class="profile-stat-value" id="projectsCount">0</div>
            <div class="profile-stat-label">Projects</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-value" id="clubsCount">0</div>
            <div class="profile-stat-label">Clubs</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-value" id="assignmentsCount">0</div>
            <div class="profile-stat-label">Assignments</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-value" id="streakCount">0</div>
            <div class="profile-stat-label">Day Streak</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="sidebar-footer">
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button id="sidebarLogout" class="btn ghost" style="flex:1; display:none">Logout</button>
        <button id="openLogin" class="btn primary" style="flex:1">Login</button>
      </div>
      <div style="text-align: center; font-size: 11px; color: var(--muted);">
        <div>Student Portal v2.0</div>
        <div id="lastSync">Last sync: --:--</div>
      </div>
    </div>
  </aside>

  <!-- Enhanced Main Content -->
  <main class="main">
    <!-- Enhanced Topbar -->
    <div class="topbar">
      <div class="search-container">
        <div class="search">
          <span class="material-symbols-outlined" style="color:var(--muted)">search</span>
          <input id="globalSearch" placeholder="Search projects, clubs, assignments, users..." aria-label="Search">
        </div>
      </div>
      <div class="top-actions">
        <div class="notification-bell" id="notificationBell" tabindex="0" aria-label="Notifications">
          <span class="material-symbols-outlined">notifications</span>
          <span class="notification-badge" id="notificationCount">0</span>
        </div>
        <div class="welcome-container">
          <div class="welcome-text" id="welcomeText">Welcome</div>
          <div class="welcome-sub" id="welcomeSub">Please sign in</div>
        </div>
      </div>
    </div>

    <!-- Enhanced Dashboard -->
    <section id="dashboard" class="card">
      <div class="card-header">
        <h2 class="card-title">Dashboard Overview</h2>
        <div class="card-actions">
          <button class="btn btn-icon ghost" id="refreshDashboard" title="Refresh">
            <span class="material-symbols-outlined">refresh</span>
          </button>
          <button class="btn btn-icon ghost" id="customizeDashboard" title="Customize">
            <span class="material-symbols-outlined">tune</span>
          </button>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">work</span>
            </div>
            <div class="widget-title">Active Projects</div>
          </div>
          <div class="widget-value" id="widgetProjects">0</div>
          <div class="widget-trend up">
            <span class="material-symbols-outlined" style="font-size:16px">trending_up</span>
            <span>+2 this week</span>
          </div>
        </div>
        
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">assignment</span>
            </div>
            <div class="widget-title">Pending Assignments</div>
          </div>
          <div class="widget-value" id="widgetAssignments">0</div>
          <div class="widget-trend down">
            <span class="material-symbols-outlined" style="font-size:16px">trending_down</span>
            <span>Due tomorrow</span>
          </div>
        </div>
        
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">groups</span>
            </div>
            <div class="widget-title">Clubs Joined</div>
          </div>
          <div class="widget-value" id="widgetClubs">0</div>
          <div class="widget-trend up">
            <span class="material-symbols-outlined" style="font-size:16px">add</span>
            <span>Join more</span>
          </div>
        </div>
        
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">trending_up</span>
            </div>
            <div class="widget-title">Activity Streak</div>
          </div>
          <div class="widget-value" id="widgetStreak">0</div>
          <div class="widget-trend up">
            <span class="material-symbols-outlined" style="font-size:16px">local_fire_department</span>
            <span>Keep it up!</span>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 24px;">
        <h3 style="margin-bottom: 16px;">Recent Activity</h3>
        <div id="recentActivity"></div>
      </div>
    </section>
    
    <!-- Enhanced Projects Section -->
    <section id="projects" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Projects</h2>
        <div class="card-actions">
          <button id="filterProjects" class="btn ghost sm">
            <span class="material-symbols-outlined" style="font-size:18px">filter_list</span> Filter
          </button>
          <button id="createProjectBtn" class="btn primary">
            <span class="material-symbols-outlined" style="font-size:18px">add</span> Create Project
          </button>
        </div>
      </div>
      <div class="projects-filters" id="projectsFilters" style="display:none; margin-bottom:20px;">
        <!-- Filters will be added dynamically -->
      </div>
      <div id="projectsList"></div>
    </section>
    
    <!-- Enhanced Assignments Section -->
    <section id="assignments" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Assignments</h2>
        <div class="card-actions">
          <select id="assignmentFilter" class="form-control" style="width:auto; padding:8px 12px;">
            <option value="all">All Assignments</option>
            <option value="pending">Pending</option>
            <option value="submitted">Submitted</option>
            <option value="graded">Graded</option>
          </select>
          <button id="submitAssignmentBtn" class="btn primary">
            <span class="material-symbols-outlined" style="font-size:18px">upload</span> Submit Assignment
          </button>
        </div>
      </div>
      <div id="assignmentsList"></div>
    </section>
    
    <!-- Enhanced Events Section -->
    <section id="events" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Upcoming Events</h2>
        <div class="card-actions">
          <button id="createEventBtn" class="btn primary admin-only">
            <span class="material-symbols-outlined" style="font-size:18px">add</span> Create Event
          </button>
        </div>
      </div>
      <div class="calendar" id="eventsCalendar"></div>
      <div id="eventsList" style="margin-top:20px;"></div>
    </section>
    
    <!-- Enhanced Conversations Section -->
    <section id="conversations" class="card admin-only" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Conversations</h2>
        <div class="card-actions">
          <button id="newConversationBtn" class="btn primary">
            <span class="material-symbols-outlined" style="font-size:18px">add_comment</span> New Conversation
          </button>
        </div>
      </div>
      <div class="chat-area">
        <div class="chat-window">
          <div class="chat-messages" id="chatWindow"></div>
        </div>
        <div class="chat-input-container">
          <input id="chatInput" placeholder="Type your message..." class="chat-input" aria-label="Message input">
          <button class="btn btn-icon" id="attachFileBtn" title="Attach file">
            <span class="material-symbols-outlined">attach_file</span>
          </button>
          <button class="btn primary" id="sendBtn">
            <span class="material-symbols-outlined">send</span> Send
          </button>
        </div>
      </div>
    </section>
    
    <!-- Enhanced Clubs Section -->
    <section id="clubs" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Clubs & Organizations</h2>
        <div class="card-actions">
          <input type="text" id="clubSearch" placeholder="Search clubs..." class="form-control" style="width:200px;">
          <button id="createClubBtn" class="btn primary admin-only">
            <span class="material-symbols-outlined" style="font-size:18px">add</span> Create Club
          </button>
        </div>
      </div>
      <div id="clubsList"></div>
    </section>
    
    <!-- Enhanced Reports Section -->
    <section id="reports" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Reports & Analytics</h2>
        <div class="card-actions">
          <select id="reportPeriod" class="form-control" style="width:auto; padding:8px 12px;">
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
          </select>
          <button id="exportReportBtn" class="btn success">
            <span class="material-symbols-outlined" style="font-size:18px">download</span> Export
          </button>
        </div>
      </div>
      <div id="reportsContent"></div>
    </section>
    
    <!-- Enhanced Profile Section -->
    <section id="profile" class="card" style="display:none">
      <div class="card-header">
        <h2 class="card-title">My Profile</h2>
        <div class="card-actions">
          <button id="changePasswordBtn" class="btn ghost">Change Password</button>
          <button id="saveProfileBtn" class="btn success">Save Profile</button>
        </div>
      </div>
      <div class="profile-form">
        <div class="form-group" style="display:flex; gap:24px; align-items:flex-start;">
          <div class="profile-avatar-upload">
            <img id="profilePic" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=200&h=200&fit=crop&crop=face" class="profile-avatar" alt="Profile Picture">
            <div class="profile-avatar-overlay" id="uploadAvatarOverlay">
              <span class="material-symbols-outlined">photo_camera</span>
            </div>
          </div>
          <div style="flex:1">
            <input type="file" id="profilePicInput" class="sr-only" accept="image/*">
            <div class="form-group">
              <label class="form-label" for="profileName">Full Name</label>
              <input type="text" id="profileName" class="form-control" placeholder="Your Full Name">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="profileEmail">Email</label>
                <input type="email" id="profileEmail" class="form-control" placeholder="your.email@example.com" disabled>
              </div>
              <div class="form-group">
                <label class="form-label" for="profileGrade">Grade</label>
                <select id="profileGrade" class="form-control form-select">
                  <option value="">Select Grade</option>
                  <option value="TC">TC</option>
                  <option value="1BAC">1BAC</option>
                  <option value="2BAC">2BAC</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="profileBio">Bio</label>
          <textarea id="profileBio" class="form-control form-textarea" placeholder="Tell us about yourself..." rows="4"></textarea>
          <div class="form-error" id="profileBioError"></div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="profilePhone">Phone Number</label>
            <input type="tel" id="profilePhone" class="form-control" placeholder="+212 6XX-XXXXXX">
          </div>
          <div class="form-group">
            <label class="form-label" for="profileLocation">Location</label>
            <input type="text" id="profileLocation" class="form-control" placeholder="City, Country">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label" for="profileSkills">Skills & Interests</label>
          <div id="skillsContainer" style="margin-bottom:8px;"></div>
          <input type="text" id="profileSkillInput" class="form-control" placeholder="Add a skill and press Enter">
          <div class="form-error" id="profileSkillsError"></div>
        </div>
      </div>
    </section>
    
    <!-- Enhanced Admin Panel -->
    <section id="admin" class="card admin-only" style="display:none">
      <div class="card-header">
        <h2 class="card-title">Admin Panel</h2>
        <div class="card-actions">
          <button id="systemHealthBtn" class="btn ghost">System Health</button>
          <button id="backupBtn" class="btn success">Backup Data</button>
        </div>
      </div>
      <div class="admin-controls">
        <button id="manageUsersBtn" class="btn primary">Manage Users</button>
        <button id="systemStatsBtn" class="btn">System Stats</button>
        <button id="manageRolesBtn" class="btn">Manage Roles</button>
        <button id="auditLogBtn" class="btn">Audit Log</button>
        <button id="settingsBtn" class="btn">Settings</button>
      </div>
      <div id="adminContent"></div>
    </section>
    
    <!-- Club sections will be dynamically added here -->
  </main>
</div>

<!-- Enhanced Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Enhanced Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div id="loadingText">Loading...</div>
  </div>
</div>

<!-- Enhanced Auth Modal -->
<div class="modal-overlay" id="authModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Welcome to Student Portal</h3>
      <button class="modal-close" id="closeAuthModal">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label" for="modalEmail">Email</label>
        <input type="email" id="modalEmail" class="form-control" placeholder="your.email@example.com">
        <div class="form-error" id="modalEmailError"></div>
      </div>
      <div class="form-group">
        <label class="form-label" for="modalPass">Password</label>
        <input type="password" id="modalPass" class="form-control" placeholder="••••••••">
        <div class="form-error" id="modalPassError"></div>
      </div>
      <div class="form-group" id="registerFields" style="display:none;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="modalFirstName">First Name</label>
            <input type="text" id="modalFirstName" class="form-control" placeholder="John">
          </div>
          <div class="form-group">
            <label class="form-label" for="modalLastName">Last Name</label>
            <input type="text" id="modalLastName" class="form-control" placeholder="Doe">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="modalGrade">Grade</label>
          <select id="modalGrade" class="form-control form-select">
            <option value="">Select Grade</option>
            <option value="TC">TC</option>
            <option value="1BAC">1BAC</option>
            <option value="2BAC">2BAC</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="modalProfilePic">Profile Picture (Optional)</label>
          <input type="file" id="modalProfilePic" class="form-control" accept="image/*">
        </div>
      </div>
      <div class="form-group">
        <div class="form-check" style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="rememberMe" class="form-check-input">
          <label for="rememberMe" style="font-size:14px;">Remember me</label>
        </div>
      </div>
      <div class="form-group">
        <button id="toggleRegister" class="btn ghost sm" style="font-size:13px;">Don't have an account? Register</button>
        <button id="forgotPassword" class="btn ghost sm" style="font-size:13px;">Forgot password?</button>
      </div>
    </div>
    <div class="modal-footer">
      <button id="modalCancel" class="btn ghost">Cancel</button>
      <button id="modalAction" class="btn primary">Login</button>
    </div>
  </div>
</div>

<!-- Enhanced Club Creation Modal -->
<div class="modal-overlay" id="createClubModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Create New Club</h3>
      <button class="modal-close" id="closeClubModal">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label" for="clubName">Club Name *</label>
        <input type="text" id="clubName" class="form-control" placeholder="e.g., Science Club">
        <div class="form-error" id="clubNameError"></div>
      </div>
      <div class="form-group">
        <label class="form-label" for="clubAbbreviation">Abbreviation *</label>
        <input type="text" id="clubAbbreviation" class="form-control" placeholder="e.g., SC" maxlength="10">
        <div class="form-error" id="clubAbbreviationError"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="clubLeader1">Primary Leader *</label>
          <input type="text" id="clubLeader1" class="form-control" placeholder="Full name">
        </div>
        <div class="form-group">
          <label class="form-label" for="clubLeader2">Secondary Leader</label>
          <input type="text" id="clubLeader2" class="form-control" placeholder="Optional">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="clubDescription">Description *</label>
        <textarea id="clubDescription" class="form-control form-textarea" placeholder="Describe the club's purpose and activities..."></textarea>
        <div class="form-error" id="clubDescriptionError"></div>
      </div>
      <div class="form-group">
        <label class="form-label" for="clubLogo">Club Logo</label>
        <input type="file" id="clubLogo" class="form-control" accept="image/*">
        <small style="color:var(--muted); font-size:12px;">Recommended: 300x300px, PNG or JPG</small>
      </div>
      <div class="form-group">
        <label class="form-label" for="clubCategory">Category</label>
        <select id="clubCategory" class="form-control form-select">
          <option value="academic">Academic</option>
          <option value="sports">Sports</option>
          <option value="arts">Arts & Culture</option>
          <option value="technology">Technology</option>
          <option value="social">Social & Community</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancelClubBtn" class="btn ghost">Cancel</button>
      <button id="saveClubBtn" class="btn success">Create Club</button>
    </div>
  </div>
</div>

<!-- Enhanced Project Creation Modal -->
<div class="modal-overlay" id="createProjectModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Create New Project</h3>
      <button class="modal-close" id="closeProjectModal">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label" for="projectTitle">Project Title *</label>
        <input type="text" id="projectTitle" class="form-control" placeholder="e.g., Science Fair Project">
        <div class="form-error" id="projectTitleError"></div>
      </div>
      <div class="form-group">
        <label class="form-label" for="projectDescription">Description *</label>
        <textarea id="projectDescription" class="form-control form-textarea" placeholder="Describe your project..."></textarea>
        <div class="form-error" id="projectDescriptionError"></div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label" for="projectDeadline">Deadline</label>
          <input type="date" id="projectDeadline" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label" for="projectStatus">Status</label>
          <select id="projectStatus" class="form-control form-select">
            <option value="planning">Planning</option>
            <option value="in-progress">In Progress</option>
            <option value="review">Under Review</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label" for="projectTeam">Team Members</label>
        <select id="projectTeam" class="form-control form-select" multiple style="height:100px;">
          <!-- Will be populated with users -->
        </select>
        <small style="color:var(--muted); font-size:12px;">Hold Ctrl/Cmd to select multiple members</small>
      </div>
      <div class="form-group">
        <label class="form-label" for="projectAttachments">Attachments</label>
        <input type="file" id="projectAttachments" class="form-control" multiple>
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancelProjectBtn" class="btn ghost">Cancel</button>
      <button id="saveProjectBtn" class="btn success">Create Project</button>
    </div>
  </div>
</div>

<!-- Enhanced Role Management Modal -->
<div class="modal-overlay" id="roleModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Manage User Role</h3>
      <button class="modal-close" id="closeRoleModal">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div id="roleUserInfo" style="margin-bottom: 24px; padding:16px; background:var(--surface-secondary); border-radius:var(--radius-sm);"></div>
      <div class="role-selector" style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px;">
        <label class="role-option" for="role-student">
          <input type="radio" id="role-student" name="userRole" value="student">
          <div style="text-align:center;">
            <span class="material-symbols-outlined" style="font-size:32px; margin-bottom:8px;">school</span>
            <div style="font-weight:600;">Student</div>
            <div style="font-size:12px; color:var(--muted);">Regular user</div>
          </div>
        </label>
        <label class="role-option" for="role-leader">
          <input type="radio" id="role-leader" name="userRole" value="leader">
          <div style="text-align:center;">
            <span class="material-symbols-outlined" style="font-size:32px; margin-bottom:8px;">leaderboard</span>
            <div style="font-weight:600;">Leader</div>
            <div style="font-size:12px; color:var(--muted);">Club leadership</div>
          </div>
        </label>
        <label class="role-option" for="role-admin">
          <input type="radio" id="role-admin" name="userRole" value="admin">
          <div style="text-align:center;">
            <span class="material-symbols-outlined" style="font-size:32px; margin-bottom:8px;">admin_panel_settings</span>
            <div style="font-weight:600;">Admin</div>
            <div style="font-size:12px; color:var(--muted);">Full system access</div>
          </div>
        </label>
        <label class="role-option" for="role-owner">
          <input type="radio" id="role-owner" name="userRole" value="owner">
          <div style="text-align:center;">
            <span class="material-symbols-outlined" style="font-size:32px; margin-bottom:8px;">security</span>
            <div style="font-weight:600;">Owner</div>
            <div style="font-size:12px; color:var(--muted);">Super administrator</div>
          </div>
        </label>
      </div>
      <div class="form-group" style="margin-top:16px;">
        <label class="form-label" for="roleNotes">Notes (Optional)</label>
        <textarea id="roleNotes" class="form-control form-textarea" placeholder="Add notes about this role change..." rows="2"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button id="cancelRoleBtn" class="btn ghost">Cancel</button>
      <button id="saveRoleBtn" class="btn success">Save Changes</button>
    </div>
  </div>
</div>

<!-- Enhanced Notification Modal -->
<div class="modal-overlay" id="notificationModal">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Notifications</h3>
      <button class="modal-close" id="closeNotificationModal">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
    <div class="modal-body">
      <div id="notificationsList"></div>
    </div>
    <div class="modal-footer">
      <button id="markAllReadBtn" class="btn ghost">Mark All as Read</button>
      <button id="clearNotificationsBtn" class="btn danger">Clear All</button>
    </div>
  </div>
</div>

<!-- Firebase SDK (IMPORTANT: Use Environment Variables in Production) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

<script>
// =============================================
// ENHANCED STUDENT PORTAL - CLASSROOM UI v2.0
// =============================================

// IMPORTANT SECURITY NOTE:
// In production, Firebase config should be loaded from environment variables
// and sensitive operations should be handled through Firebase Functions
// or a backend server with proper authentication middleware.

// --- Configuration ---
const CONFIG = {
  appName: 'Student Portal v2.0',
  version: '2.0.0',
  defaultProfilePic: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=200&h=200&fit=crop&crop=face',
  maxFileSize: 5 * 1024 * 1024, // 5MB
  supportedImageTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],
  paginationLimit: 10,
  cacheDuration: 5 * 60 * 1000, // 5 minutes
  sessionTimeout: 30 * 60 * 1000, // 30 minutes
};

// --- Firebase Configuration ---
// WARNING: This should be loaded from environment variables in production
// Consider using Firebase Functions or a backend server for sensitive operations
const firebaseConfig = {
  apiKey: "AIzaSyBcvybNF9Hn89jb2zRQxknb6l0uMeiS-EM",
  authDomain: "school-bni-yekhlef-id.firebaseapp.com",
  projectId: "bniyekhlef-high-school",
  storageBucket: "school-bni-yekhlef-id",
  messagingSenderId: "893030570286",
  appId: "1:893030570286:web:bec5df8427b532f5e202bf",
  measurementId: "G-4V7JRRR48W"
};

// --- Initialize Firebase ---
try {
  firebase.initializeApp(firebaseConfig);
} catch (err) {
  console.error('Firebase initialization error:', err);
}

const analytics = firebase.analytics();
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
// const functions = firebase.functions(); // Uncomment if using Cloud Functions

// Enable offline persistence
db.enablePersistence().catch((err) => {
  console.error('Offline persistence failed:', err);
});

// --- State Management ---
const State = {
  currentUser: null,
  userData: null,
  userRole: 'guest',
  notifications: [],
  unreadNotifications: 0,
  activeTab: 'dashboard',
  clubTabs: new Map(),
  cachedData: new Map(),
  lastCacheTime: new Map(),
  sessionTimer: null,
  isOnline: navigator.onLine,
};

// --- Enhanced UI Functions ---

class Toast {
  static show(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <span class="material-symbols-outlined toast-icon">
        ${this.getIconForType(type)}
      </span>
      <div class="toast-content">
        <div class="toast-title">${this.getTitleForType(type)}</div>
        <div class="toast-message">${message}</div>
      </div>
      <button class="toast-close">
        <span class="material-symbols-outlined">close</span>
      </button>
    `;
    
    container.appendChild(toast);
    
    // Show with animation
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Auto remove
    const autoRemove = setTimeout(() => this.remove(toast), duration);
    
    // Manual close
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.onclick = () => this.remove(toast);
    
    toast._autoRemove = autoRemove;
  }
  
  static remove(toast) {
    if (toast._autoRemove) clearTimeout(toast._autoRemove);
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }
  
  static getIconForType(type) {
    const icons = {
      success: 'check_circle',
      error: 'error',
      warning: 'warning',
      info: 'info'
    };
    return icons[type] || 'info';
  }
  
  static getTitleForType(type) {
    const titles = {
      success: 'Success',
      error: 'Error',
      warning: 'Warning',
      info: 'Info'
    };
    return titles[type] || 'Info';
  }
}

class Modal {
  static show(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  }
  
  static hide(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  }
  
  static closeAll() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.style.display = 'none';
    });
    document.body.style.overflow = 'auto';
  }
}

class Loading {
  static show(text = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    const textEl = document.getElementById('loadingText');
    textEl.textContent = text;
    overlay.classList.add('show');
  }
  
  static hide() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.remove('show');
  }
}

// --- Form Validation ---
class Validator {
  static validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
  }
  
  static validatePassword(password) {
    return password.length >= 6;
  }
  
  static validateRequired(value) {
    return value && value.trim().length > 0;
  }
  
  static validateFile(file, options = {}) {
    if (!file) return true;
    
    const { maxSize = CONFIG.maxFileSize, types = CONFIG.supportedImageTypes } = options;
    
    if (file.size > maxSize) {
      return { valid: false, error: `File size must be less than ${maxSize / 1024 / 1024}MB` };
    }
    
    if (!types.includes(file.type)) {
      return { valid: false, error: `File type must be one of: ${types.join(', ')}` };
    }
    
    return { valid: true };
  }
}

// --- Data Caching ---
class Cache {
  static set(key, data, duration = CONFIG.cacheDuration) {
    State.cachedData.set(key, {
      data,
      timestamp: Date.now(),
      duration
    });
  }
  
  static get(key) {
    const cached = State.cachedData.get(key);
    if (!cached) return null;
    
    const isExpired = Date.now() - cached.timestamp > cached.duration;
    if (isExpired) {
      State.cachedData.delete(key);
      return null;
    }
    
    return cached.data;
  }
  
  static clear(key = null) {
    if (key) {
      State.cachedData.delete(key);
    } else {
      State.cachedData.clear();
    }
  }
}

// --- Enhanced Error Handling ---
class ErrorHandler {
  static handle(error, context = '') {
    console.error(`[${context}]`, error);
    
    let userMessage = 'An error occurred';
    
    if (error.code) {
      switch (error.code) {
        case 'auth/user-not-found':
          userMessage = 'User not found';
          break;
        case 'auth/wrong-password':
          userMessage = 'Invalid password';
          break;
        case 'auth/email-already-in-use':
          userMessage = 'Email already in use';
          break;
        case 'auth/weak-password':
          userMessage = 'Password is too weak';
          break;
        case 'auth/network-request-failed':
          userMessage = 'Network error. Please check your connection';
          break;
        case 'permission-denied':
          userMessage = 'You do not have permission to perform this action';
          break;
        case 'unavailable':
          userMessage = 'Service temporarily unavailable';
          break;
      }
    }
    
    Toast.show(`${context ? context + ': ' : ''}${userMessage}`, 'error');
    
    // Log to analytics if available
    if (analytics) {
      analytics.logEvent('error', {
        context,
        error_code: error.code,
        error_message: error.message
      });
    }
  }
}

// --- Session Management ---
class SessionManager {
  static start() {
    this.updateLastActivity();
    
    // Set up activity listeners
    ['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
      document.addEventListener(event, this.updateLastActivity.bind(this));
    });
    
    // Set up online/offline detection
    window.addEventListener('online', this.handleOnline.bind(this));
    window.addEventListener('offline', this.handleOffline.bind(this));
    
    // Start session timer
    State.sessionTimer = setInterval(this.checkSession.bind(this), 60000); // Check every minute
  }
  
  static updateLastActivity() {
    State.lastActivity = Date.now();
  }
  
  static checkSession() {
    if (!State.currentUser) return;
    
    const idleTime = Date.now() - State.lastActivity;
    if (idleTime > CONFIG.sessionTimeout) {
      Toast.show('Session expired due to inactivity', 'warning');
      this.logout();
    }
  }
  
  static handleOnline() {
    State.isOnline = true;
    Toast.show('Back online', 'success', 2000);
    // Sync any pending data
    this.syncPendingData();
  }
  
  static handleOffline() {
    State.isOnline = false;
    Toast.show('You are offline. Some features may be limited.', 'warning', 5000);
  }
  
  static async syncPendingData() {
    // Implement offline data sync here
    // This would sync any locally cached changes to Firestore
  }
  
  static logout() {
    if (State.sessionTimer) {
      clearInterval(State.sessionTimer);
    }
    auth.signOut();
  }
}

// --- Enhanced Authentication System ---
class AuthManager {
  static async login(email, password, rememberMe = false) {
    try {
      Loading.show('Signing in...');
      
      const persistence = rememberMe ? 
        firebase.auth.Auth.Persistence.LOCAL : 
        firebase.auth.Auth.Persistence.SESSION;
      
      await auth.setPersistence(persistence);
      const result = await auth.signInWithEmailAndPassword(email, password);
      
      // Track login in analytics
      analytics.logEvent('login', { method: 'email' });
      
      return result;
    } catch (error) {
      ErrorHandler.handle(error, 'Login');
      throw error;
    } finally {
      Loading.hide();
    }
  }
  
  static async register(email, password, userData) {
    try {
      Loading.show('Creating account...');
      
      const result = await auth.createUserWithEmailAndPassword(email, password);
      
      // Create user profile
      const profileData = {
        uid: result.user.uid,
        email: email,
        name: `${userData.firstName} ${userData.lastName}`,
        firstName: userData.firstName,
        lastName: userData.lastName,
        grade: userData.grade,
        role: 'student', // Default role
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'active'
      };
      
      // Upload profile picture if provided
      if (userData.profilePic) {
        const photoURL = await this.uploadProfilePicture(result.user.uid, userData.profilePic);
        profileData.photoURL = photoURL;
      }
      
      // Create user document
      await db.collection('users').doc(result.user.uid).set(profileData);
      
      // Create user stats document
      await db.collection('userStats').doc(result.user.uid).set({
        uid: result.user.uid,
        projects: 0,
        clubs: 0,
        assignments: 0,
        streak: 0,
        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      analytics.logEvent('sign_up', { method: 'email' });
      
      return result;
    } catch (error) {
      ErrorHandler.handle(error, 'Registration');
      throw error;
    } finally {
      Loading.hide();
    }
  }
  
  static async uploadProfilePicture(uid, file) {
    const validation = Validator.validateFile(file);
    if (!validation.valid) {
      throw new Error(validation.error);
    }
    
    const storageRef = storage.ref();
    const fileRef = storageRef.child(`profilePictures/${uid}/${Date.now()}_${file.name}`);
    
    const snapshot = await fileRef.put(file);
    return await snapshot.ref.getDownloadURL();
  }
  
  static async resetPassword(email) {
    try {
      await auth.sendPasswordResetEmail(email);
      Toast.show('Password reset email sent', 'success');
    } catch (error) {
      ErrorHandler.handle(error, 'Password Reset');
    }
  }
  
  static async updatePassword(newPassword) {
    try {
      await State.currentUser.updatePassword(newPassword);
      Toast.show('Password updated successfully', 'success');
    } catch (error) {
      ErrorHandler.handle(error, 'Password Update');
    }
  }
}

// --- Enhanced User Management ---
class UserManager {
  static async getUserData(uid) {
    try {
      // Try cache first
      const cached = Cache.get(`user_${uid}`);
      if (cached) return cached;
      
      const doc = await db.collection('users').doc(uid).get();
      if (!doc.exists) return null;
      
      const data = doc.data();
      Cache.set(`user_${uid}`, data);
      
      return data;
    } catch (error) {
      ErrorHandler.handle(error, 'Get User Data');
      return null;
    }
  }
  
  static async updateUserProfile(uid, updates) {
    try {
      await db.collection('users').doc(uid).update({
        ...updates,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Clear cache
      Cache.clear(`user_${uid}`);
      
      Toast.show('Profile updated successfully', 'success');
      return true;
    } catch (error) {
      ErrorHandler.handle(error, 'Update Profile');
      return false;
    }
  }
  
  static async getAllUsers(filters = {}) {
    try {
      let query = db.collection('users');
      
      // Apply filters
      if (filters.role) {
        query = query.where('role', '==', filters.role);
      }
      if (filters.grade) {
        query = query.where('grade', '==', filters.grade);
      }
      if (filters.status) {
        query = query.where('status', '==', filters.status);
      }
      
      const snapshot = await query.get();
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
      ErrorHandler.handle(error, 'Get All Users');
      return [];
    }
  }
  
  static async updateUserRole(uid, newRole, notes = '') {
    try {
      const batch = db.batch();
      
      // Update user role
      batch.update(db.collection('users').doc(uid), {
        role: newRole,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Log role change
      batch.set(db.collection('auditLog').doc(), {
        action: 'role_change',
        userId: uid,
        oldRole: State.userData?.role,
        newRole: newRole,
        performedBy: State.currentUser.uid,
        performedByEmail: State.currentUser.email,
        notes: notes,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      await batch.commit();
      
      Toast.show(`Role updated to ${newRole}`, 'success');
      return true;
    } catch (error) {
      ErrorHandler.handle(error, 'Update User Role');
      return false;
    }
  }
}

// --- Enhanced Notification System ---
class NotificationManager {
  static async sendNotification(userId, title, message, type = 'info', data = {}) {
    try {
      await db.collection('notifications').add({
        userId: userId,
        title: title,
        message: message,
        type: type,
        data: data,
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (error) {
      console.error('Error sending notification:', error);
    }
  }
  
  static async getUserNotifications(uid) {
    try {
      const snapshot = await db.collection('notifications')
        .where('userId', '==', uid)
        .orderBy('createdAt', 'desc')
        .limit(50)
        .get();
      
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
      ErrorHandler.handle(error, 'Get Notifications');
      return [];
    }
  }
  
  static async markAsRead(notificationId) {
    try {
      await db.collection('notifications').doc(notificationId).update({
        read: true,
        readAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (error) {
      console.error('Error marking notification as read:', error);
    }
  }
  
  static async markAllAsRead(uid) {
    try {
      const snapshot = await db.collection('notifications')
        .where('userId', '==', uid)
        .where('read', '==', false)
        .get();
      
      const batch = db.batch();
      snapshot.docs.forEach(doc => {
        batch.update(doc.ref, {
          read: true,
          readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      
      await batch.commit();
    } catch (error) {
      console.error('Error marking all notifications as read:', error);
    }
  }
}

// --- Enhanced Club System ---
class ClubManager {
  static async createClub(clubData) {
    try {
      Loading.show('Creating club...');
      
      // Upload logo if provided
      let logoURL = null;
      if (clubData.logo) {
        const validation = Validator.validateFile(clubData.logo);
        if (!validation.valid) {
          throw new Error(validation.error);
        }
        
        const storageRef = storage.ref();
        const logoRef = storageRef.child(`clubLogos/${Date.now()}_${clubData.logo.name}`);
        const snapshot = await logoRef.put(clubData.logo);
        logoURL = await snapshot.ref.getDownloadURL();
      }
      
      const clubDoc = {
        name: clubData.name,
        abbreviation: clubData.abbreviation,
        description: clubData.description,
        category: clubData.category,
        leader1: clubData.leader1,
        leader2: clubData.leader2 || '',
        createdBy: State.currentUser.uid,
        creatorEmail: State.currentUser.email,
        logoURL: logoURL,
        members: [State.currentUser.uid],
        memberCount: 1,
        funds: 0,
        projects: [],
        events: [],
        status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      const result = await db.collection('clubs').add(clubDoc);
      
      // Send notifications to admins
      const admins = await UserManager.getAllUsers({ role: 'admin' });
      admins.forEach(admin => {
        NotificationManager.sendNotification(
          admin.id,
          'New Club Created',
          `${clubData.name} has been created by ${State.userData.name}`,
          'info',
          { clubId: result.id }
        );
      });
      
      Toast.show('Club created successfully!', 'success');
      return result.id;
    } catch (error) {
      ErrorHandler.handle(error, 'Create Club');
      throw error;
    } finally {
      Loading.hide();
    }
  }
  
  static async joinClub(clubId) {
    try {
      const clubRef = db.collection('clubs').doc(clubId);
      const clubDoc = await clubRef.get();
      
      if (!clubDoc.exists) {
        throw new Error('Club not found');
      }
      
      const clubData = clubDoc.data();
      if (clubData.members.includes(State.currentUser.uid)) {
        Toast.show('You are already a member of this club', 'warning');
        return;
      }
      
      await clubRef.update({
        members: firebase.firestore.FieldValue.arrayUnion(State.currentUser.uid),
        memberCount: clubData.members.length + 1,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update user stats
      await db.collection('userStats').doc(State.currentUser.uid).update({
        clubs: firebase.firestore.FieldValue.increment(1),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Send notification to club leaders
      NotificationManager.sendNotification(
        clubData.createdBy,
        'New Club Member',
        `${State.userData.name} has joined ${clubData.name}`,
        'info',
        { clubId: clubId, userId: State.currentUser.uid }
      );
      
      Toast.show('Successfully joined the club!', 'success');
      
      // Update UI
      this.updateClubUI(clubId, clubData);
    } catch (error) {
      ErrorHandler.handle(error, 'Join Club');
    }
  }
  
  static updateClubUI(clubId, clubData) {
    // Create club tab if not exists
    if (!State.clubTabs.has(clubId)) {
      createClubTab(clubId, clubData);
    }
    
    // Update clubs count
    updateUserStats();
  }
}

// --- Enhanced Project System ---
class ProjectManager {
  static async createProject(projectData) {
    try {
      Loading.show('Creating project...');
      
      const projectDoc = {
        title: projectData.title,
        description: projectData.description,
        status: projectData.status || 'planning',
        deadline: projectData.deadline || null,
        createdBy: State.currentUser.uid,
        creatorEmail: State.currentUser.email,
        creatorName: State.userData.name,
        team: projectData.team || [],
        attachments: [],
        comments: [],
        progress: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      const result = await db.collection('projects').add(projectDoc);
      
      // Update user stats
      await db.collection('userStats').doc(State.currentUser.uid).update({
        projects: firebase.firestore.FieldValue.increment(1),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      Toast.show('Project created successfully!', 'success');
      return result.id;
    } catch (error) {
      ErrorHandler.handle(error, 'Create Project');
      throw error;
    } finally {
      Loading.hide();
    }
  }
  
  static async getProjects(filters = {}) {
    try {
      let query = db.collection('projects');
      
      if (filters.userId) {
        query = query.where('createdBy', '==', filters.userId);
      }
      
      if (filters.status) {
        query = query.where('status', '==', filters.status);
      }
      
      if (filters.teamMember) {
        query = query.where('team', 'array-contains', filters.teamMember);
      }
      
      const snapshot = await query
        .orderBy('createdAt', 'desc')
        .limit(CONFIG.paginationLimit)
        .get();
      
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
      ErrorHandler.handle(error, 'Get Projects');
      return [];
    }
  }
}

// --- Enhanced Dashboard System ---
class DashboardManager {
  static async loadDashboardData() {
    try {
      if (!State.currentUser) return;
      
      const [projects, clubs, assignments, notifications] = await Promise.all([
        ProjectManager.getProjects({ userId: State.currentUser.uid }),
        this.getUserClubs(),
        this.getUserAssignments(),
        NotificationManager.getUserNotifications(State.currentUser.uid)
      ]);
      
      // Update dashboard widgets
      this.updateWidgets(projects.length, clubs.length, assignments.pending, State.userData.streak || 0);
      
      // Update recent activity
      this.updateRecentActivity([...projects, ...clubs, ...assignments.all]);
      
      // Update notifications
      this.updateNotifications(notifications);
      
      // Update profile stats
      updateProfileStats();
    } catch (error) {
      ErrorHandler.handle(error, 'Load Dashboard');
    }
  }
  
  static async getUserClubs() {
    try {
      const snapshot = await db.collection('clubs')
        .where('members', 'array-contains', State.currentUser.uid)
        .get();
      
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
      ErrorHandler.handle(error, 'Get User Clubs');
      return [];
    }
  }
  
  static async getUserAssignments() {
    try {
      // This is a simplified version - implement based on your assignment structure
      const pending = await db.collection('assignments')
        .where('assignedTo', 'array-contains', State.currentUser.uid)
        .where('submitted', '==', false)
        .get();
      
      const all = await db.collection('assignments')
        .where('assignedTo', 'array-contains', State.currentUser.uid)
        .get();
      
      return {
        pending: pending.size,
        all: all.docs.map(doc => ({ id: doc.id, ...doc.data() }))
      };
    } catch (error) {
      ErrorHandler.handle(error, 'Get User Assignments');
      return { pending: 0, all: [] };
    }
  }
  
  static updateWidgets(projects, clubs, assignments, streak) {
    document.getElementById('widgetProjects').textContent = projects;
    document.getElementById('widgetClubs').textContent = clubs;
    document.getElementById('widgetAssignments').textContent = assignments;
    document.getElementById('widgetStreak').textContent = streak;
    
    // Update profile stats
    document.getElementById('projectsCount').textContent = projects;
    document.getElementById('clubsCount').textContent = clubs;
    document.getElementById('assignmentsCount').textContent = assignments;
    document.getElementById('streakCount').textContent = streak;
  }
  
  static updateRecentActivity(items) {
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    items.sort((a, b) => {
      const dateA = a.createdAt?.toDate() || new Date(0);
      const dateB = b.createdAt?.toDate() || new Date(0);
      return dateB - dateA;
    });
    
    const recentItems = items.slice(0, 5);
    
    container.innerHTML = recentItems.map(item => `
      <div class="list-item">
        <div class="list-item-content">
          <div class="list-item-title">${item.title || item.name}</div>
          <div class="list-item-subtitle">${item.description || ''}</div>
          <div class="list-item-meta">
            <span>${item.createdAt ? item.createdAt.toDate().toLocaleDateString() : 'Recent'}</span>
            <span class="status-badge ${item.status || 'active'}">${item.status || 'Active'}</span>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  static updateNotifications(notifications) {
    State.notifications = notifications;
    State.unreadNotifications = notifications.filter(n => !n.read).length;
    
    // Update notification badge
    const badge = document.getElementById('notificationCount');
    if (badge) {
      badge.textContent = State.unreadNotifications;
      badge.style.display = State.unreadNotifications > 0 ? 'flex' : 'none';
    }
  }
}

// --- Enhanced Chat System ---
class ChatManager {
  static async sendMessage(message, attachments = []) {
    try {
      if (!message.trim()) return;
      
      const chatData = {
        text: message.trim(),
        sender: State.currentUser.uid,
        senderEmail: State.currentUser.email,
        senderName: State.userData.name,
        senderPhoto: State.userData.photoURL || CONFIG.defaultProfilePic,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        readBy: [State.currentUser.uid],
        attachments: []
      };
      
      // Upload attachments if any
      if (attachments.length > 0) {
        const uploadedAttachments = await Promise.all(
          attachments.map(file => this.uploadAttachment(file))
        );
        chatData.attachments = uploadedAttachments;
      }
      
      await db.collection('messages').add(chatData);
      
      // Clear input
      document.getElementById('chatInput').value = '';
      
    } catch (error) {
      ErrorHandler.handle(error, 'Send Message');
    }
  }
  
  static async uploadAttachment(file) {
    try {
      const validation = Validator.validateFile(file, {
        maxSize: 10 * 1024 * 1024, // 10MB for chat attachments
        types: [...CONFIG.supportedImageTypes, 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
      });
      
      if (!validation.valid) {
        throw new Error(validation.error);
      }
      
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`chatAttachments/${Date.now()}_${file.name}`);
      const snapshot = await fileRef.put(file);
      const url = await snapshot.ref.getDownloadURL();
      
      return {
        name: file.name,
        type: file.type,
        size: file.size,
        url: url
      };
    } catch (error) {
      ErrorHandler.handle(error, 'Upload Attachment');
      return null;
    }
  }
  
  static listenForMessages(callback) {
    return db.collection('messages')
      .orderBy('timestamp', 'desc')
      .limit(50)
      .onSnapshot(snapshot => {
        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(messages.reverse()); // Reverse to show oldest first
      }, error => {
        ErrorHandler.handle(error, 'Listen Messages');
      });
  }
}

// --- UI Initialization ---
function initUI() {
  // Sidebar navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', handleNavigation);
    item.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        handleNavigation(e);
      }
    });
  });
  
  // Auth modal
  document.getElementById('openLogin').addEventListener('click', () => Modal.show('authModal'));
  document.getElementById('closeAuthModal').addEventListener('click', () => Modal.hide('authModal'));
  document.getElementById('modalCancel').addEventListener('click', () => Modal.hide('authModal'));
  document.getElementById('toggleRegister').addEventListener('click', toggleRegisterMode);
  document.getElementById('forgotPassword').addEventListener('click', handleForgotPassword);
  document.getElementById('modalAction').addEventListener('click', handleAuthAction);
  
  // Club modal
  document.getElementById('createClubBtn').addEventListener('click', () => Modal.show('createClubModal'));
  document.getElementById('closeClubModal').addEventListener('click', () => Modal.hide('createClubModal'));
  document.getElementById('cancelClubBtn').addEventListener('click', () => Modal.hide('createClubModal'));
  document.getElementById('saveClubBtn').addEventListener('click', handleCreateClub);
  
  // Project modal
  document.getElementById('createProjectBtn').addEventListener('click', () => Modal.show('createProjectModal'));
  document.getElementById('closeProjectModal').addEventListener('click', () => Modal.hide('createProjectModal'));
  document.getElementById('cancelProjectBtn').addEventListener('click', () => Modal.hide('createProjectModal'));
  document.getElementById('saveProjectBtn').addEventListener('click', handleCreateProject);
  
  // Role modal
  document.getElementById('closeRoleModal').addEventListener('click', () => Modal.hide('roleModal'));
  document.getElementById('cancelRoleBtn').addEventListener('click', () => Modal.hide('roleModal'));
  document.getElementById('saveRoleBtn').addEventListener('click', handleSaveRole);
  
  // Notification modal
  document.getElementById('notificationBell').addEventListener('click', () => Modal.show('notificationModal'));
  document.getElementById('closeNotificationModal').addEventListener('click', () => Modal.hide('notificationModal'));
  document.getElementById('markAllReadBtn').addEventListener('click', handleMarkAllRead);
  document.getElementById('clearNotificationsBtn').addEventListener('click', handleClearNotifications);
  
  // Chat
  document.getElementById('sendBtn').addEventListener('click', handleSendMessage);
  document.getElementById('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  });
  
  // Profile
  document.getElementById('saveProfileBtn').addEventListener('click', handleSaveProfile);
  document.getElementById('uploadAvatarOverlay').addEventListener('click', () => {
    document.getElementById('profilePicInput').click();
  });
  document.getElementById('profilePicInput').addEventListener('change', handleProfilePicChange);
  document.getElementById('changePasswordBtn').addEventListener('click', handleChangePassword);
  document.getElementById('profileSkillInput').addEventListener('keypress', handleSkillInput);
  
  // Dashboard
  document.getElementById('refreshDashboard').addEventListener('click', () => DashboardManager.loadDashboardData());
  
  // Admin
  document.getElementById('manageUsersBtn').addEventListener('click', handleManageUsers);
  document.getElementById('systemStatsBtn').addEventListener('click', handleSystemStats);
  document.getElementById('manageRolesBtn').addEventListener('click', handleManageRoles);
  document.getElementById('auditLogBtn').addEventListener('click', handleAuditLog);
  document.getElementById('settingsBtn').addEventListener('click', handleSettings);
  document.getElementById('systemHealthBtn').addEventListener('click', handleSystemHealth);
  document.getElementById('backupBtn').addEventListener('click', handleBackup);
  
  // Search
  document.getElementById('globalSearch').addEventListener('input', handleSearch);
  
  // Logout
  document.getElementById('sidebarLogout').addEventListener('click', handleLogout);
  
  // Initialize session manager
  SessionManager.start();
  
  // Set up online status indicator
  updateOnlineStatus();
  
  // Set up sync indicator
  setInterval(updateLastSync, 60000); // Update every minute
}

// --- Event Handlers ---
async function handleNavigation(e) {
  const item = e.currentTarget;
  const tab = item.dataset.tab;
  
  // Update active state
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  item.classList.add('active');
  
  // Hide all sections
  document.querySelectorAll('main section').forEach(sec => {
    sec.style.display = 'none';
  });
  
  // Show selected section
  const section = document.getElementById(tab);
  if (section) {
    section.style.display = 'block';
    State.activeTab = tab;
    
    // Load section data
    await loadSectionData(tab);
  }
}

async function handleAuthAction() {
  const email = document.getElementById('modalEmail').value;
  const password = document.getElementById('modalPass').value;
  const isRegisterMode = document.getElementById('registerFields').style.display !== 'none';
  
  // Validation
  if (!Validator.validateEmail(email)) {
    Toast.show('Please enter a valid email address', 'error');
    return;
  }
  
  if (!Validator.validatePassword(password)) {
    Toast.show('Password must be at least 6 characters', 'error');
    return;
  }
  
  try {
    if (isRegisterMode) {
      const firstName = document.getElementById('modalFirstName').value;
      const lastName = document.getElementById('modalLastName').value;
      const grade = document.getElementById('modalGrade').value;
      const profilePic = document.getElementById('modalProfilePic').files[0];
      
      if (!Validator.validateRequired(firstName) || !Validator.validateRequired(lastName)) {
        Toast.show('Please enter your name', 'error');
        return;
      }
      
      if (!Validator.validateRequired(grade)) {
        Toast.show('Please select your grade', 'error');
        return;
      }
      
      await AuthManager.register(email, password, {
        firstName,
        lastName,
        grade,
        profilePic
      });
      
      Modal.hide('authModal');
      Toast.show('Account created successfully!', 'success');
    } else {
      const rememberMe = document.getElementById('rememberMe').checked;
      await AuthManager.login(email, password, rememberMe);
      Modal.hide('authModal');
    }
  } catch (error) {
    // Error already handled by AuthManager
  }
}

function toggleRegisterMode() {
  const registerFields = document.getElementById('registerFields');
  const toggleBtn = document.getElementById('toggleRegister');
  const actionBtn = document.getElementById('modalAction');
  
  if (registerFields.style.display === 'none') {
    registerFields.style.display = 'block';
    toggleBtn.textContent = 'Already have an account? Login';
    actionBtn.textContent = 'Register';
  } else {
    registerFields.style.display = 'none';
    toggleBtn.textContent = 'Don\'t have an account? Register';
    actionBtn.textContent = 'Login';
  }
}

async function handleForgotPassword() {
  const email = document.getElementById('modalEmail').value;
  if (!Validator.validateEmail(email)) {
    Toast.show('Please enter your email address', 'error');
    return;
  }
  
  await AuthManager.resetPassword(email);
}

async function handleCreateClub() {
  const name = document.getElementById('clubName').value;
  const abbreviation = document.getElementById('clubAbbreviation').value;
  const leader1 = document.getElementById('clubLeader1').value;
  const description = document.getElementById('clubDescription').value;
  const category = document.getElementById('clubCategory').value;
  const logo = document.getElementById('clubLogo').files[0];
  const leader2 = document.getElementById('clubLeader2').value;
  
  // Validation
  if (!Validator.validateRequired(name)) {
    Toast.show('Club name is required', 'error');
    return;
  }
  
  if (!Validator.validateRequired(abbreviation)) {
    Toast.show('Club abbreviation is required', 'error');
    return;
  }
  
  if (!Validator.validateRequired(leader1)) {
    Toast.show('Primary leader is required', 'error');
    return;
  }
  
  if (!Validator.validateRequired(description)) {
    Toast.show('Description is required', 'error');
    return;
  }
  
  try {
    await ClubManager.createClub({
      name,
      abbreviation,
      leader1,
      leader2,
      description,
      category,
      logo
    });
    
    Modal.hide('createClubModal');
    clearClubForm();
  } catch (error) {
    // Error already handled by ClubManager
  }
}

async function handleCreateProject() {
  const title = document.getElementById('projectTitle').value;
  const description = document.getElementById('projectDescription').value;
  const deadline = document.getElementById('projectDeadline').value;
  const status = document.getElementById('projectStatus').value;
  const teamSelect = document.getElementById('projectTeam');
  const attachments = document.getElementById('projectAttachments').files;
  
  // Validation
  if (!Validator.validateRequired(title)) {
    Toast.show('Project title is required', 'error');
    return;
  }
  
  if (!Validator.validateRequired(description)) {
    Toast.show('Description is required', 'error');
    return;
  }
  
  const team = Array.from(teamSelect.selectedOptions).map(opt => opt.value);
  
  try {
    await ProjectManager.createProject({
      title,
      description,
      deadline: deadline || null,
      status,
      team,
      attachments: Array.from(attachments)
    });
    
    Modal.hide('createProjectModal');
    clearProjectForm();
  } catch (error) {
    // Error already handled by ProjectManager
  }
}

async function handleSaveProfile() {
  const name = document.getElementById('profileName').value;
  const grade = document.getElementById('profileGrade').value;
  const bio = document.getElementById('profileBio').value;
  const phone = document.getElementById('profilePhone').value;
  const location = document.getElementById('profileLocation').value;
  
  if (!Validator.validateRequired(name)) {
    Toast.show('Name is required', 'error');
    return;
  }
  
  const updates = {
    name,
    grade,
    bio,
    phone,
    location,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  await UserManager.updateUserProfile(State.currentUser.uid, updates);
  updateUIForUser(State.userData);
}

async function handleChangePassword() {
  const newPassword = prompt('Enter new password (min 6 characters):');
  if (!newPassword) return;
  
  if (!Validator.validatePassword(newPassword)) {
    Toast.show('Password must be at least 6 characters', 'error');
    return;
  }
  
  const confirmPassword = prompt('Confirm new password:');
  if (newPassword !== confirmPassword) {
    Toast.show('Passwords do not match', 'error');
    return;
  }
  
  await AuthManager.updatePassword(newPassword);
}

async function handleSendMessage() {
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  await ChatManager.sendMessage(message);
  input.value = '';
}

async function handleManageUsers() {
  Loading.show('Loading users...');
  
  try {
    const users = await UserManager.getAllUsers();
    displayUsersTable(users);
  } catch (error) {
    ErrorHandler.handle(error, 'Load Users');
  } finally {
    Loading.hide();
  }
}

function displayUsersTable(users) {
  const container = document.getElementById('adminContent');
  
  container.innerHTML = `
    <div class="admin-table-container">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Grade</th>
            <th>Role</th>
            <th>Status</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${users.map(user => `
            <tr>
              <td>
                <div style="display:flex; align-items:center; gap:8px;">
                  <img src="${user.photoURL || CONFIG.defaultProfilePic}" 
                       style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                  ${user.name}
                </div>
              </td>
              <td>${user.email}</td>
              <td>${user.grade || '-'}</td>
              <td><span class="role-badge ${user.role}">${user.role}</span></td>
              <td><span class="status-badge ${user.status || 'active'}">${user.status || 'Active'}</span></td>
              <td>${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : '-'}</td>
              <td>
                <button class="btn sm" onclick="openRoleModal('${user.id}', '${user.name}', '${user.role}')">
                  Change Role
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function openRoleModal(userId, userName, currentRole) {
  document.getElementById('roleUserInfo').innerHTML = `
    <div><strong>User:</strong> ${userName}</div>
    <div><strong>Current Role:</strong> <span class="role-badge ${currentRole}">${currentRole}</span></div>
  `;
  
  // Set current role as selected
  document.querySelectorAll('input[name="userRole"]').forEach(radio => {
    radio.checked = radio.value === currentRole;
    const option = radio.closest('.role-option');
    if (radio.checked) {
      option.classList.add('selected');
    } else {
      option.classList.remove('selected');
    }
  });
  
  document.getElementById('roleNotes').value = '';
  State.roleModalUserId = userId;
  Modal.show('roleModal');
}

async function handleSaveRole() {
  const selectedRole = document.querySelector('input[name="userRole"]:checked');
  if (!selectedRole) {
    Toast.show('Please select a role', 'error');
    return;
  }
  
  const notes = document.getElementById('roleNotes').value;
  const newRole = selectedRole.value;
  
  await UserManager.updateUserRole(State.roleModalUserId, newRole, notes);
  Modal.hide('roleModal');
  handleManageUsers(); // Refresh table
}

async function handleSystemStats() {
  Loading.show('Loading statistics...');
  
  try {
    const [users, projects, clubs, messages, assignments] = await Promise.all([
      db.collection('users').get(),
      db.collection('projects').get(),
      db.collection('clubs').get(),
      db.collection('messages').get(),
      db.collection('assignments').get()
    ]);
    
    const container = document.getElementById('adminContent');
    
    container.innerHTML = `
      <div class="dashboard-grid">
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">people</span>
            </div>
            <div class="widget-title">Total Users</div>
          </div>
          <div class="widget-value">${users.size}</div>
          <div class="widget-trend up">
            <span class="material-symbols-outlined" style="font-size:16px">trending_up</span>
            <span>Active</span>
          </div>
        </div>
        
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">work</span>
            </div>
            <div class="widget-title">Active Projects</div>
          </div>
          <div class="widget-value">${projects.size}</div>
          <div class="widget-trend up">
            <span class="material-symbols-outlined" style="font-size:16px">trending_up</span>
            <span>Growing</span>
          </div>
        </div>
        
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">groups</span>
            </div>
            <div class="widget-title">Clubs</div>
          </div>
          <div class="widget-value">${clubs.size}</div>
          <div class="widget-trend up">
            <span class="material-symbols-outlined" style="font-size:16px">add</span>
            <span>Active</span>
          </div>
        </div>
        
        <div class="dashboard-widget">
          <div class="widget-header">
            <div class="widget-icon">
              <span class="material-symbols-outlined">chat</span>
            </div>
            <div class="widget-title">Messages</div>
          </div>
          <div class="widget-value">${messages.size}</div>
          <div class="widget-trend up">
            <span class="material-symbols-outlined" style="font-size:16px">trending_up</span>
            <span>Today: ${messages.size}</span>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 24px;">
        <h3>System Health</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-top:16px;">
          <div style="padding:16px; background:var(--surface-secondary); border-radius:var(--radius-sm);">
            <div style="font-size:12px; color:var(--muted);">Database Status</div>
            <div style="font-weight:600; color:var(--success);">● Healthy</div>
          </div>
          <div style="padding:16px; background:var(--surface-secondary); border-radius:var(--radius-sm);">
            <div style="font-size:12px; color:var(--muted);">Storage Usage</div>
            <div style="font-weight:600;">${Math.round(projects.size * 0.1)}MB</div>
          </div>
          <div style="padding:16px; background:var(--surface-secondary); border-radius:var(--radius-sm);">
            <div style="font-size:12px; color:var(--muted);">Active Sessions</div>
            <div style="font-weight:600;">${users.size}</div>
          </div>
        </div>
      </div>
    `;
  } catch (error) {
    ErrorHandler.handle(error, 'Load System Stats');
  } finally {
    Loading.hide();
  }
}

async function handleMarkAllRead() {
  await NotificationManager.markAllAsRead(State.currentUser.uid);
  DashboardManager.updateNotifications(State.notifications.map(n => ({ ...n, read: true })));
  Modal.hide('notificationModal');
}

async function handleClearNotifications() {
  // Implement notification clearing
  Toast.show('Clearing notifications...', 'info');
  // Note: In production, you'd want to implement actual deletion
  Modal.hide('notificationModal');
}

function handleSearch(e) {
  const query = e.target.value.toLowerCase();
  // Implement search functionality
  // This would filter lists based on the query
}

async function handleLogout() {
  await SessionManager.logout();
}

// --- UI Update Functions ---
function updateUIForUser(userData) {
  if (!userData) return;
  
  // Update sidebar
  document.getElementById('sideName').textContent = userData.name || 'Guest';
  document.getElementById('sideRole').textContent = getRoleDisplay(userData.role);
  document.getElementById('sideProfilePic').src = userData.photoURL || CONFIG.defaultProfilePic;
  
  // Update topbar
  document.getElementById('welcomeText').textContent = `Welcome, ${userData.firstName || userData.name || 'User'}`;
  document.getElementById('welcomeSub').textContent = getRoleDisplay(userData.role) + ' Dashboard';
  
  // Update login/logout buttons
  document.getElementById('openLogin').style.display = 'none';
  document.getElementById('sidebarLogout').style.display = 'block';
  
  // Show/hide admin features
  const isAdmin = userData.role === 'admin' || userData.role === 'owner';
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? 'block' : 'none';
  });
  
  // Update profile form
  document.getElementById('profileName').value = userData.name || '';
  document.getElementById('profileEmail').value = userData.email || '';
  document.getElementById('profileGrade').value = userData.grade || '';
  document.getElementById('profileBio').value = userData.bio || '';
  document.getElementById('profilePhone').value = userData.phone || '';
  document.getElementById('profileLocation').value = userData.location || '';
  document.getElementById('profilePic').src = userData.photoURL || CONFIG.defaultProfilePic;
  
  // Update skills
  if (userData.skills) {
    updateSkillsDisplay(userData.skills);
  }
}

function updateUIForGuest() {
  // Update sidebar
  document.getElementById('sideName').textContent = 'Guest User';
  document.getElementById('sideRole').textContent = 'Not signed in';
  document.getElementById('sideProfilePic').src = CONFIG.defaultProfilePic;
  
  // Update topbar
  document.getElementById('welcomeText').textContent = 'Welcome';
  document.getElementById('welcomeSub').textContent = 'Please sign in';
  
  // Update login/logout buttons
  document.getElementById('openLogin').style.display = 'block';
  document.getElementById('sidebarLogout').style.display = 'none';
  
  // Hide admin features
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = 'none';
  });
  
  // Reset profile form
  document.getElementById('profileName').value = '';
  document.getElementById('profileEmail').value = '';
  document.getElementById('profileGrade').value = '';
  document.getElementById('profileBio').value = '';
  document.getElementById('profilePhone').value = '';
  document.getElementById('profileLocation').value = '';
  document.getElementById('profilePic').src = CONFIG.defaultProfilePic;
  
  // Clear skills
  updateSkillsDisplay([]);
}

function getRoleDisplay(role) {
  const roles = {
    student: 'Student',
    leader: 'Club Leader',
    admin: 'Administrator',
    owner: 'System Owner',
    guest: 'Guest'
  };
  return roles[role] || 'User';
}

function updateProfileStats() {
  // This would update the profile stats in real-time
  // For now, we'll update from dashboard data
}

function updateSkillsDisplay(skills) {
  const container = document.getElementById('skillsContainer');
  container.innerHTML = skills.map(skill => `
    <span style="display:inline-flex; align-items:center; gap:4px; padding:4px 12px; background:var(--surface-secondary); border-radius:16px; font-size:12px; margin:0 4px 4px 0;">
      ${skill}
      <button onclick="removeSkill('${skill}')" style="background:none; border:none; cursor:pointer; padding:0; color:var(--muted);">
        <span class="material-symbols-outlined" style="font-size:14px;">close</span>
      </button>
    </span>
  `).join('');
}

function handleSkillInput(e) {
  if (e.key === 'Enter' && e.target.value.trim()) {
    const skill = e.target.value.trim();
    // Add skill to user profile
    // This would update the user document with the new skill
    e.target.value = '';
  }
}

function removeSkill(skill) {
  // Remove skill from user profile
  // This would update the user document
}

function updateOnlineStatus() {
  const indicator = document.querySelector('.online-status');
  if (indicator) {
    indicator.textContent = State.isOnline ? 'Online' : 'Offline';
    indicator.style.color = State.isOnline ? 'var(--success)' : 'var(--warning)';
  }
}

function updateLastSync() {
  const element = document.getElementById('lastSync');
  if (element) {
    const now = new Date();
    element.textContent = `Last sync: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
  }
}

function clearClubForm() {
  document.getElementById('clubName').value = '';
  document.getElementById('clubAbbreviation').value = '';
  document.getElementById('clubLeader1').value = '';
  document.getElementById('clubLeader2').value = '';
  document.getElementById('clubDescription').value = '';
  document.getElementById('clubLogo').value = '';
  document.getElementById('clubCategory').value = 'academic';
}

function clearProjectForm() {
  document.getElementById('projectTitle').value = '';
  document.getElementById('projectDescription').value = '';
  document.getElementById('projectDeadline').value = '';
  document.getElementById('projectStatus').value = 'planning';
  document.getElementById('projectTeam').selectedIndex = -1;
  document.getElementById('projectAttachments').value = '';
}

function handleProfilePicChange(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const validation = Validator.validateFile(file);
  if (!validation.valid) {
    Toast.show(validation.error, 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('profilePic').src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// --- Section Loading ---
async function loadSectionData(section) {
  switch(section) {
    case 'dashboard':
      await DashboardManager.loadDashboardData();
      break;
    case 'projects':
      await loadProjects();
      break;
    case 'clubs':
      await loadClubs();
      break;
    case 'profile':
      await loadProfileData();
      break;
    case 'admin':
      await loadAdminData();
      break;
  }
}

async function loadProjects() {
  const projects = await ProjectManager.getProjects();
  const container = document.getElementById('projectsList');
  
  if (!projects.length) {
    container.innerHTML = '<div class="list-item">No projects yet. Create one to get started!</div>';
    return;
  }
  
  container.innerHTML = projects.map(project => `
    <div class="list-item">
      <div class="list-item-content">
        <div class="list-item-title">${project.title}</div>
        <div class="list-item-subtitle">${project.description}</div>
        <div class="list-item-meta">
          <span>Created: ${project.createdAt.toDate().toLocaleDateString()}</span>
          <span>Status: <span class="status-badge ${project.status}">${project.status}</span></span>
          <span>Team: ${project.team.length + 1} members</span>
        </div>
      </div>
      <div class="list-item-actions">
        <button class="btn sm ghost">View</button>
        <button class="btn sm primary">Edit</button>
      </div>
    </div>
  `).join('');
}

async function loadClubs() {
  const clubs = await ClubManager.getUserClubs();
  const container = document.getElementById('clubsList');
  
  if (!clubs.length) {
    container.innerHTML = '<div class="club-card">No clubs yet. Join or create a club!</div>';
    return;
  }
  
  container.innerHTML = clubs.map(club => `
    <div class="club-card">
      <div class="club-header">
        ${club.logoURL ? 
          `<img src="${club.logoURL}" class="club-logo" alt="${club.name} Logo">` : 
          '<div class="club-logo"><span class="material-symbols-outlined">groups</span></div>'
        }
        <div class="club-info">
          <h3 class="club-name">${club.name}</h3>
          <p class="club-abbr">${club.abbreviation}</p>
          <p class="club-leaders">Leaders: ${club.leader1}${club.leader2 ? `, ${club.leader2}` : ''}</p>
          <p class="club-description">${club.description}</p>
        </div>
      </div>
      <div class="club-stats">
        <div class="club-stat">
          <div class="club-stat-value">${club.memberCount}</div>
          <div class="club-stat-label">Members</div>
        </div>
        <div class="club-stat">
          <div class="club-stat-value">${club.funds || 0} DH</div>
          <div class="club-stat-label">Funds</div>
        </div>
        <div class="club-stat">
          <div class="club-stat-value">${club.projects ? club.projects.length : 0}</div>
          <div class="club-stat-label">Projects</div>
        </div>
        <div class="club-stat">
          <div class="club-stat-value">${club.events ? club.events.length : 0}</div>
          <div class="club-stat-label">Events</div>
        </div>
      </div>
      <div class="club-actions">
        <button class="btn sm ghost">View Club</button>
        <button class="btn sm primary" onclick="ClubManager.joinClub('${club.id}')">Join Club</button>
      </div>
    </div>
  `).join('');
}

async function loadProfileData() {
  // Profile data is already loaded in updateUIForUser
  // Additional profile data loading can be done here
}

async function loadAdminData() {
  // Default to user management
  handleManageUsers();
}

// --- Initialize the application ---
document.addEventListener('DOMContentLoaded', () => {
  initUI();
  
  // Set up auth state listener
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      State.currentUser = user;
      State.userData = await UserManager.getUserData(user.uid);
      State.userRole = State.userData?.role || 'student';
      
      updateUIForUser(State.userData);
      
      // Load initial data
      await DashboardManager.loadDashboardData();
      
      // Set up chat listener if on conversations page
      if (State.activeTab === 'conversations') {
        ChatManager.listenForMessages((messages) => {
          updateChatUI(messages);
        });
      }
    } else {
      State.currentUser = null;
      State.userData = null;
      State.userRole = 'guest';
      
      updateUIForGuest();
    }
  });
  
  // Initialize toast container
  if (!document.getElementById('toastContainer')) {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  
  // Show welcome message
  setTimeout(() => {
    Toast.show('Welcome to Enhanced Student Portal!', 'info', 3000);
  }, 1000);
});

// --- Utility functions for global access ---
function createClubTab(clubId, clubData) {
  if (State.clubTabs.has(clubId)) return;
  
  // Create sidebar tab
  const sidebarNav = document.querySelector('.sidebar-nav');
  const clubTab = document.createElement('div');
  clubTab.className = 'nav-item club-tab';
  clubTab.dataset.tab = `club-${clubId}`;
  clubTab.innerHTML = `
    <span class="material-symbols-outlined icon">groups</span>${clubData.abbreviation}
  `;
  clubTab.addEventListener('click', handleNavigation);
  sidebarNav.appendChild(clubTab);
  
  // Create club section
  const main = document.querySelector('.main');
  const clubSection = document.createElement('section');
  clubSection.id = `club-${clubId}`;
  clubSection.className = 'card';
  clubSection.style.display = 'none';
  
  clubSection.innerHTML = `
    <div class="club-tab-content">
      <div class="club-header">
        ${clubData.logoURL ? 
          `<img src="${clubData.logoURL}" class="club-logo" alt="${clubData.name} Logo">` : 
          '<div class="club-logo"><span class="material-symbols-outlined">groups</span></div>'
        }
        <div class="club-info">
          <h3>${clubData.name} (${clubData.abbreviation})</h3>
          <p class="club-leaders">Leaders: ${clubData.leader1}${clubData.leader2 ? `, ${clubData.leader2}` : ''}</p>
          <p>${clubData.description}</p>
        </div>
      </div>
      
      <div class="club-section">
        <h4><span class="material-symbols-outlined">account_balance</span>Club Funds</h4>
        <div class="funds-display">${clubData.funds || 0} DH</div>
        <p>Current available funds for club activities and projects.</p>
      </div>
      
      <div class="club-section">
        <h4><span class="material-symbols-outlined">work</span>Active Projects</h4>
        <div id="club-projects-${clubId}">
          ${clubData.projects && clubData.projects.length > 0 ? 
            clubData.projects.map(p => `
              <div class="project-item">
                <h5 class="project-title">${p.title}</h5>
                <p class="project-desc">${p.description}</p>
                <small>Status: ${p.status || 'In Progress'}</small>
              </div>
            `).join('') : 
            '<p>No active projects.</p>'
          }
        </div>
      </div>
      
      <div class="club-section">
        <h4><span class="material-symbols-outlined">groups</span>Members</h4>
        <p>Total Members: ${clubData.memberCount || 1}</p>
        <div id="club-members-${clubId}"></div>
      </div>
    </div>
  `;
  
  main.appendChild(clubSection);
  State.clubTabs.set(clubId, clubData);
}

function updateChatUI(messages) {
  const container = document.getElementById('chatWindow');
  if (!container) return;
  
  container.innerHTML = messages.map(msg => {
    const isSent = msg.sender === State.currentUser.uid;
    return `
      <div class="message ${isSent ? 'sent' : ''}">
        <div class="meta">
          <span class="message-sender">${msg.senderName}</span>
          <span class="message-time">${msg.timestamp ? msg.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now'}</span>
        </div>
        <div class="message-text">${msg.text}</div>
        ${msg.attachments && msg.attachments.length > 0 ? `
          <div class="message-attachments">
            ${msg.attachments.map(att => `
              <a href="${att.url}" target="_blank" style="display:inline-flex; align-items:center; gap:4px; padding:4px 8px; background:rgba(255,255,255,0.1); border-radius:4px; font-size:12px;">
                <span class="material-symbols-outlined" style="font-size:14px;">attach_file</span>
                ${att.name}
              </a>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
  
  // Scroll to bottom
  container.scrollTop = container.scrollHeight;
}

// Placeholder functions for unimplemented features
function handleManageRoles() { Toast.show('Feature coming soon', 'info'); }
function handleAuditLog() { Toast.show('Feature coming soon', 'info'); }
function handleSettings() { Toast.show('Feature coming soon', 'info'); }
function handleSystemHealth() { Toast.show('Feature coming soon', 'info'); }
function handleBackup() { Toast.show('Feature coming soon', 'info'); }

// Export for debugging
window.AppState = State;
window.AppModules = {
  Toast,
  Modal,
  Loading,
  AuthManager,
  UserManager,
  ClubManager,
  ProjectManager,
  DashboardManager,
  ChatManager,
  NotificationManager
};
</script>
</body>
</html>
