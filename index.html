<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Student Portal â€” Classroom UI</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<style>
/* --- NEW UI STYLES --- */
:root {
  --bg: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);
  --surface: #ffffff;
  --muted: #6b7280;
  --primary: #1a1a1a;
  --accent: #4a5568;
  --danger: #e53e3e;
  --success: #38a169;
  --warning: #d69e2e;
  --shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
  --radius: 12px;
  --maxWidth: 1200px;
  --gap: 16px;
  font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 24px;
  background: var(--bg);
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  display: flex;
  justify-content: center;
  color: #1a1a1a;
}

.app {
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: var(--gap);
  width: 100%;
  max-width: var(--maxWidth);
  align-items: start;
}

.sidebar {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
  position: sticky;
  top: 24px;
  height: calc(100vh - 48px);
  overflow: auto;
}

.brand {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 14px;
}

.logo {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, #1a1a1a, #4a5568);
  border-radius: 10px;
  color: white;
  font-weight: 700;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.brand .title {
  font-weight: 600;
  font-size: 16px;
}

.brand .sub {
  font-size: 12px;
  color: var(--muted);
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 8px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  border-radius: 10px;
  font-weight: 500;
  color: #1a1a1a;
  cursor: pointer;
  transition: all 0.2s;
}

.nav-item:hover {
  background: #f7fafc;
}

.nav-item.active {
  background: linear-gradient(90deg, rgba(26, 26, 26, 0.08), rgba(26, 26, 26, 0.04));
  border-left: 4px solid var(--primary);
  padding-left: 8px;
}

.icon {
  font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
  font-size: 20px;
  color: var(--primary);
}

.profile-card {
  margin-top: 16px;
  padding: 12px;
  border-radius: 10px;
  background: linear-gradient(90deg, #f8fafc, #fff);
  border: 1px solid #e2e8f0;
}

.profile-name {
  font-weight: 600;
}

.profile-role {
  font-size: 12px;
  color: var(--muted);
}

.sidebar button {
  width: 100%;
}

.main {
  display: flex;
  flex-direction: column;
  gap: var(--gap);
}

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
}

.search {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface);
  border-radius: 12px;
  padding: 8px 10px;
  box-shadow: var(--shadow);
  min-width: 420px;
  max-width: 640px;
}

.search input {
  border: 0;
  outline: 0;
  background: transparent;
  width: 100%;
  font-size: 14px;
}

.top-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.card {
  background: var(--surface);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow);
}

.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

.section-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  margin-bottom: 8px;
  background: #fff;
}

.chat-area {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.chat-window {
  height: 300px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
  padding: 12px;
  overflow: auto;
  background: #f8fbff;
}

.message {
  padding: 10px;
  border-radius: 8px;
  background: #eef6ff;
  margin-bottom: 8px;
}

.message .meta {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

.chat-input {
  display: flex;
  gap: 10px;
  align-items: center;
}

.chat-input input {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
  background: #ffffff;
}

.btn {
  padding: 10px 12px;
  border-radius: 10px;
  border: 0;
  background: var(--primary);
  color: white;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.btn:hover {
  background: #2d3748;
}

.btn.ghost {
  background: transparent;
  border: 1px solid #e2e8f0;
  color: var(--primary);
}

.btn.danger {
  background: var(--danger);
}

.btn.success {
  background: var(--success);
}

.btn.warning {
  background: var(--warning);
}

#authModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.45);
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

#authModal>div {
  background: var(--surface);
  padding: 22px;
  border-radius: 12px;
  max-width: 520px;
  width: 100%;
  box-shadow: var(--shadow);
}

@media (max-width: 980px) {
  .app {
    grid-template-columns: 1fr;
    padding-bottom: 160px;
  }
  .sidebar {
    position: relative;
    height: auto;
  }
  .search {
    min-width: unset;
    width: 100%;
  }
  .chat-window {
    height: 200px;
  }
}

/* Additional styles for improved UI */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  background: var(--surface);
  box-shadow: var(--shadow);
  z-index: 1001;
  transform: translateX(150%);
  transition: transform 0.3s ease;
}

.toast.show {
  transform: translateX(0);
}

.toast.success {
  border-left: 4px solid #10b981;
}

.toast.error {
  border-left: 4px solid var(--danger);
}

.toast.warning {
  border-left: 4px solid var(--warning);
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, .3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* Profile styles */
.profile-pic {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid var(--primary);
  margin-bottom: 16px;
}

.profile-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 500px;
}

.profile-form textarea {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  resize: vertical;
  min-height: 100px;
  font-family: inherit;
}

.file-input {
  padding: 8px;
  border-radius: 8px;
  border: 1px dashed #e2e8f0;
}

/* Admin styles */
.admin-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}

.admin-table th, .admin-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e2e8f0;
}

.admin-table th {
  background: #f8fafc;
  font-weight: 600;
}

/* Role badges */
.role-badge {
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.role-admin {
  background: #fee2e2;
  color: #dc2626;
}

.role-leader {
  background: #fef3c7;
  color: #d97706;
}

.role-student {
  background: #dbeafe;
  color: #2563eb;
}

.role-owner {
  background: #f3e8ff;
  color: #7c3aed;
}

/* Create forms */
.create-form {
  background: #f8fafc;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
}

.create-form input, .create-form textarea, .create-form select {
  width: 100%;
  padding: 10px;
  margin-bottom: 12px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  font-family: inherit;
}

/* Club styles */
.club-logo {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  border: 2px solid #e2e8f0;
}

.club-card {
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  background: white;
}

.club-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.club-info {
  flex: 1;
}

.club-name {
  font-weight: 600;
  font-size: 18px;
  margin: 0;
}

.club-abbr {
  font-size: 14px;
  color: var(--muted);
  margin: 0;
}

.club-leaders {
  font-size: 14px;
  margin: 4px 0;
}

.club-stats {
  display: flex;
  gap: 16px;
  margin-top: 12px;
}

.club-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.club-stat-value {
  font-weight: 600;
  font-size: 18px;
}

.club-stat-label {
  font-size: 12px;
  color: var(--muted);
}

/* Club tab styles */
.club-tab-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.club-section {
  background: #f8fafc;
  border-radius: 8px;
  padding: 16px;
}

.club-section h4 {
  margin-top: 0;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.funds-display {
  font-size: 24px;
  font-weight: 700;
  color: var(--success);
  margin: 8px 0;
}

.project-item {
  background: white;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  border-left: 4px solid var(--primary);
}

.project-title {
  font-weight: 600;
  margin: 0 0 4px 0;
}

.project-desc {
  font-size: 14px;
  color: var(--muted);
  margin: 0;
}

/* Registration form styles */
.registration-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.form-row {
  display: flex;
  gap: 12px;
}

.form-row > * {
  flex: 1;
}

/* Role selector styles */
.role-selector {
  display: flex;
  gap: 8px;
  margin: 12px 0;
}

.role-option {
  flex: 1;
  padding: 10px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.role-option.selected {
  border-color: var(--primary);
  background: #f7fafc;
}

.role-option input {
  display: none;
}

/* Admin-only content */
.admin-only {
  display: none;
}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">SP</div>
      <div>
        <div class="title">Student Portal</div>
        <div class="sub">Classroom UI</div>
      </div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" data-tab="dashboard">
        <span class="material-symbols-outlined icon">home</span>Dashboard
      </div>
      <div class="nav-item" data-tab="projects">
        <span class="material-symbols-outlined icon">work</span>Projects
      </div>
      <div class="nav-item" data-tab="assignments">
        <span class="material-symbols-outlined icon">assignment</span>Assignments
      </div>
      <div class="nav-item" data-tab="events">
        <span class="material-symbols-outlined icon">event</span>Events
      </div>
      <div id="conversationsNav" class="nav-item admin-only" data-tab="conversations">
        <span class="material-symbols-outlined icon">chat_bubble</span>Conversations
      </div>
      <div class="nav-item" data-tab="clubs">
        <span class="material-symbols-outlined icon">account_balance</span>Clubs
      </div>
      <div class="nav-item" data-tab="reports">
        <span class="material-symbols-outlined icon">report</span>Reports
      </div>
      <div class="nav-item" data-tab="profile">
        <span class="material-symbols-outlined icon">person</span>Profile
      </div>
      <div id="adminNav" class="nav-item admin-only" data-tab="admin">
        <span class="material-symbols-outlined icon">admin_panel_settings</span>Admin Panel
      </div>
      <!-- Club tabs will be dynamically added here -->
    </nav>
    <div class="profile-card">
      <div class="profile-name" id="sideName">Guest</div>
      <div class="profile-role" id="sideRole">Not signed in</div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="sidebarLogout" class="btn ghost" style="flex:1; display:none">Logout</button>
      <button id="openLogin" class="btn" style="flex:1">Login</button>
    </div>
  </aside>

  <!-- Main content -->
  <main class="main">
    <div class="topbar">
      <div class="search">
        <span class="material-symbols-outlined" style="color:var(--muted)">search</span>
        <input id="globalSearch" placeholder="Search projects, clubs, assignments...">
      </div>
      <div class="top-actions">
        <div style="text-align:right">
          <div id="welcomeText" style="font-weight:600">Welcome</div>
          <div class="small-muted" id="welcomeSub">Please sign in</div>
        </div>
      </div>
    </div>

    <!-- Sections -->
    <section id="dashboard" class="card">
      <h3>Dashboard</h3>
      <p>Welcome to your student dashboard. Select a section from the sidebar to get started.</p>
    </section>
    
    <section id="projects" class="card" style="display:none">
      <div class="section-title">
        <h3>Projects</h3>
        <button id="createProjectBtn" class="btn">Create Project</button>
      </div>
      <div id="projectsList"></div>
    </section>
    
    <section id="assignments" class="card" style="display:none">
      <h3>Assignments</h3>
      <div id="assignmentsList"></div>
    </section>
    
    <section id="events" class="card" style="display:none">
      <h3>Events</h3>
      <div id="eventsList"></div>
    </section>
    
    <section id="conversations" class="card admin-only" style="display:none">
      <h3>Conversations</h3>
      <div class="chat-area">
        <div class="chat-window" id="chatWindow"></div>
        <div class="chat-input">
          <input id="chatInput" placeholder="Type your message...">
          <button class="btn" id="sendBtn">Send</button>
        </div>
      </div>
    </section>
    
    <section id="clubs" class="card" style="display:none">
      <div class="section-title">
        <h3>Clubs</h3>
        <button id="createClubBtn" class="btn admin-only">Create Club</button>
      </div>
      <div id="clubsList"></div>
    </section>
    
    <section id="reports" class="card" style="display:none">
      <h3>Reports</h3>
      <div id="reportsList"></div>
    </section>
    
    <section id="profile" class="card" style="display:none">
      <h3>Profile</h3>
      <div class="profile-form">
        <img id="profilePic" src="https://via.placeholder.com/100" class="profile-pic" alt="Profile Picture">
        <input type="file" id="profilePicInput" class="file-input" accept="image/*">
        <input type="text" id="profileName" placeholder="Your Full Name">
        <select id="profileGrade">
          <option value="">Select Grade</option>
          <option value="TC">TC</option>
          <option value="1BAC">1BAC</option>
          <option value="2BAC">2BAC</option>
        </select>
        <textarea id="profileBio" placeholder="Write something about yourself..."></textarea>
        <button id="saveProfileBtn" class="btn">Save Profile</button>
      </div>
    </section>
    
    <section id="admin" class="card admin-only" style="display:none">
      <h3>Admin Panel</h3>
      <div class="admin-controls">
        <button id="manageUsersBtn" class="btn">Manage Users</button>
        <button id="systemStatsBtn" class="btn">System Stats</button>
        <button id="manageRolesBtn" class="btn">Manage Roles</button>
      </div>
      <div id="adminContent"></div>
    </section>
    
    <!-- Club sections will be dynamically added here -->
  </main>
</div>

<!-- Auth Modal -->
<div id="authModal">
  <div>
    <h3>Sign in / Register</h3>
    <div class="registration-form">
      <div class="form-row">
        <input id="modalFirstName" placeholder="First Name" style="width:100%;padding:8px;margin:4px 0">
        <input id="modalLastName" placeholder="Last Name" style="width:100%;padding:8px;margin:4px 0">
      </div>
      <input id="modalEmail" placeholder="Email" style="width:100%;padding:8px;margin:4px 0">
      <input id="modalPass" type="password" placeholder="Password" style="width:100%;padding:8px;margin:4px 0">
      <select id="modalGrade" style="width:100%;padding:8px;margin:4px 0">
        <option value="">Select Grade</option>
        <option value="TC">TC</option>
        <option value="1BAC">1BAC</option>
        <option value="2BAC">2BAC</option>
      </select>
      <input type="file" id="modalProfilePic" class="file-input" accept="image/*">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="modalRegister" class="btn ghost">Register</button>
      <button id="modalLogin" class="btn">Login</button>
    </div>
  </div>
</div>

<!-- Create Club Modal -->
<div id="createClubModal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.45);align-items:center;justify-content:center;z-index:1000;">
  <div style="background:var(--surface);padding:22px;border-radius:12px;max-width:520px;width:100%;box-shadow:var(--shadow);">
    <h3>Create New Club</h3>
    <input id="clubName" placeholder="Club Name" style="width:100%;padding:8px;margin:4px 0">
    <input id="clubAbbreviation" placeholder="Club Abbreviation" style="width:100%;padding:8px;margin:4px 0">
    <input id="clubLeader1" placeholder="Primary Leader Name" style="width:100%;padding:8px;margin:4px 0">
    <input id="clubLeader2" placeholder="Secondary Leader Name (Optional)" style="width:100%;padding:8px;margin:4px 0">
    <textarea id="clubDescription" placeholder="Club Description" style="width:100%;padding:8px;margin:4px 0; min-height:100px"></textarea>
    <input type="file" id="clubLogo" class="file-input" accept="image/*">
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="cancelClubBtn" class="btn ghost">Cancel</button>
      <button id="saveClubBtn" class="btn">Create Club</button>
    </div>
  </div>
</div>

<!-- Create Project Modal -->
<div id="createProjectModal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.45);align-items:center;justify-content:center;z-index:1000;">
  <div style="background:var(--surface);padding:22px;border-radius:12px;max-width:520px;width:100%;box-shadow:var(--shadow);">
    <h3>Create New Project</h3>
    <input id="projectTitle" placeholder="Project Title" style="width:100%;padding:8px;margin:4px 0">
    <textarea id="projectDescription" placeholder="Project Description" style="width:100%;padding:8px;margin:4px 0; min-height:100px"></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="cancelProjectBtn" class="btn ghost">Cancel</button>
      <button id="saveProjectBtn" class="btn">Create Project</button>
    </div>
  </div>
</div>

<!-- Role Management Modal -->
<div id="roleModal" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,0.45);align-items:center;justify-content:center;z-index:1000;">
  <div style="background:var(--surface);padding:22px;border-radius:12px;max-width:520px;width:100%;box-shadow:var(--shadow);">
    <h3>Manage User Role</h3>
    <div id="roleUserInfo" style="margin-bottom: 16px;"></div>
    <div class="role-selector">
      <label class="role-option" for="role-student">
        <input type="radio" id="role-student" name="userRole" value="student">
        <div>Student</div>
      </label>
      <label class="role-option" for="role-leader">
        <input type="radio" id="role-leader" name="userRole" value="leader">
        <div>Leader</div>
      </label>
      <label class="role-option" for="role-admin">
        <input type="radio" id="role-admin" name="userRole" value="admin">
        <div>Admin</div>
      </label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="cancelRoleBtn" class="btn ghost">Cancel</button>
      <button id="saveRoleBtn" class="btn">Save Role</button>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// --- Supabase config ---
const SUPABASE_URL = 'https://dvytzmiicvkdfwjtguel.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2eXR6bWlpY3ZrZGZ3anRndWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODY1ODMsImV4cCI6MjA4MDA2MjU4M30.s1kBfmPvoryQ8knS4aJarSk0r_WRMzmLCq7B-n9Dhqs';

// Initialize Supabase client
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- UI Functions ---
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 4000);
}

function setLoading(button, isLoading) {
  if (isLoading) {
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>';
  } else {
    button.disabled = false;
    button.innerHTML = button.getAttribute('data-original-text');
  }
}

// --- Sidebar navigation ---
const navItems = document.querySelectorAll(".nav-item");
navItems.forEach(item => {
  item.addEventListener("click", () => {
    document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
    const tab = item.dataset.tab;
    document.getElementById(tab).style.display = "block";
    navItems.forEach(i => i.classList.remove("active"));
    item.classList.add("active");
  });
});

// --- Modal toggle ---
const authModal = document.getElementById("authModal");
const openLoginBtn = document.getElementById("openLogin");
openLoginBtn.addEventListener("click", () => authModal.style.display = "flex");
authModal.addEventListener("click", e => { 
  if(e.target === authModal) authModal.style.display = "none"; 
});

// --- Role Management Modal ---
const roleModal = document.getElementById("roleModal");
const cancelRoleBtn = document.getElementById("cancelRoleBtn");
const saveRoleBtn = document.getElementById("saveRoleBtn");
let currentRoleUser = null;

cancelRoleBtn.addEventListener("click", () => {
  roleModal.style.display = "none";
  currentRoleUser = null;
});

saveRoleBtn.addEventListener("click", () => {
  if (!currentRoleUser) return;
  
  const selectedRole = document.querySelector('input[name="userRole"]:checked');
  if (!selectedRole) {
    showToast('Please select a role', 'error');
    return;
  }
  
  const newRole = selectedRole.value;
  
  saveRoleBtn.setAttribute('data-original-text', saveRoleBtn.textContent);
  setLoading(saveRoleBtn, true);
  
  updateUserRole(currentRoleUser.id, newRole)
    .then(() => {
      showToast(`Role updated to ${newRole} for ${currentRoleUser.name}`);
      roleModal.style.display = "none";
      currentRoleUser = null;
      loadUsersForAdmin();
    })
    .catch(err => {
      showToast(err.message, 'error');
    })
    .finally(() => {
      setLoading(saveRoleBtn, false);
    });
});

// Role selector interaction
document.querySelectorAll('.role-option').forEach(option => {
  option.addEventListener('click', () => {
    document.querySelectorAll('.role-option').forEach(o => o.classList.remove('selected'));
    option.classList.add('selected');
    option.querySelector('input').checked = true;
  });
});

// --- Club Creation Modal ---
const createClubModal = document.getElementById("createClubModal");
const createClubBtn = document.getElementById("createClubBtn");
const cancelClubBtn = document.getElementById("cancelClubBtn");
const saveClubBtn = document.getElementById("saveClubBtn");

createClubBtn.addEventListener("click", () => {
  createClubModal.style.display = "flex";
});

cancelClubBtn.addEventListener("click", () => {
  createClubModal.style.display = "none";
});

saveClubBtn.addEventListener("click", () => {
  const name = document.getElementById("clubName").value;
  const abbreviation = document.getElementById("clubAbbreviation").value;
  const leader1 = document.getElementById("clubLeader1").value;
  const leader2 = document.getElementById("clubLeader2").value;
  const description = document.getElementById("clubDescription").value;
  const logoFile = document.getElementById("clubLogo").files[0];
  
  if (!name || !abbreviation || !leader1 || !description) {
    showToast('Please fill in all required fields', 'error');
    return;
  }
  
  const user = supabase.auth.user();
  if (!user) {
    showToast('Please log in to create clubs', 'error');
    return;
  }
  
  saveClubBtn.setAttribute('data-original-text', saveClubBtn.textContent);
  setLoading(saveClubBtn, true);
  
  let uploadPromise = Promise.resolve(null);
  
  // Upload logo if selected (Note: Supabase Storage implementation would go here)
  // For now, we'll skip file upload for simplicity
  if (logoFile) {
    showToast('File upload not implemented in this demo', 'warning');
  }
  
  uploadPromise
    .then(logoURL => {
      const clubData = {
        name: name,
        abbreviation: abbreviation,
        leader1: leader1,
        leader2: leader2 || '',
        description: description,
        created_by: user.id,
        creator_email: user.email,
        created_at: new Date().toISOString(),
        members: [user.id],
        member_count: 1,
        funds: 0,
        projects: []
      };
      
      if (logoURL) {
        clubData.logo_url = logoURL;
      }
      
      return createClub(clubData);
    })
    .then(() => {
      showToast("Club created successfully!");
      createClubModal.style.display = "none";
      document.getElementById("clubName").value = "";
      document.getElementById("clubAbbreviation").value = "";
      document.getElementById("clubLeader1").value = "";
      document.getElementById("clubLeader2").value = "";
      document.getElementById("clubDescription").value = "";
      document.getElementById("clubLogo").value = "";
    })
    .catch(err => {
      showToast(err.message, 'error');
    })
    .finally(() => {
      setLoading(saveClubBtn, false);
    });
});

// --- Project Creation Modal ---
const createProjectModal = document.getElementById("createProjectModal");
const createProjectBtn = document.getElementById("createProjectBtn");
const cancelProjectBtn = document.getElementById("cancelProjectBtn");
const saveProjectBtn = document.getElementById("saveProjectBtn");

createProjectBtn.addEventListener("click", () => {
  createProjectModal.style.display = "flex";
});

cancelProjectBtn.addEventListener("click", () => {
  createProjectModal.style.display = "none";
});

saveProjectBtn.addEventListener("click", () => {
  const title = document.getElementById("projectTitle").value;
  const description = document.getElementById("projectDescription").value;
  
  if (!title || !description) {
    showToast('Please fill in all fields', 'error');
    return;
  }
  
  const user = supabase.auth.user();
  if (!user) {
    showToast('Please log in to create projects', 'error');
    return;
  }
  
  saveProjectBtn.setAttribute('data-original-text', saveProjectBtn.textContent);
  setLoading(saveProjectBtn, true);
  
  createProject({
    title: title,
    description: description,
    created_by: user.id,
    creator_email: user.email,
    created_at: new Date().toISOString(),
    status: "active"
  })
  .then(() => {
    showToast("Project created successfully!");
    createProjectModal.style.display = "none";
    document.getElementById("projectTitle").value = "";
    document.getElementById("projectDescription").value = "";
  })
  .catch(err => {
    showToast(err.message, 'error');
  })
  .finally(() => {
    setLoading(saveProjectBtn, false);
  });
});

// --- Chat System ---
const sendBtn = document.getElementById("sendBtn");
const chatInput = document.getElementById("chatInput");
const chatWindow = document.getElementById("chatWindow");

sendBtn.addEventListener("click", sendMessage);
chatInput.addEventListener("keypress", (e) => {
  if (e.key === 'Enter') sendMessage();
});

function sendMessage() {
  const message = chatInput.value.trim();
  if (!message) return;
  
  const user = supabase.auth.user();
  if (!user) {
    showToast('Please log in to send messages', 'error');
    return;
  }
  
  // Check if user has admin role
  getUserRole(user.id)
    .then(role => {
      if (role !== 'admin' && role !== 'owner') {
        showToast('Only administrators can send messages', 'error');
        return;
      }
      
      // User is admin/owner, allow sending message
      createMessage({
        text: message,
        sender: user.id,
        sender_email: user.email,
        sender_name: user.user_metadata?.name || user.email,
        timestamp: new Date().toISOString()
      })
      .then(() => {
        chatInput.value = "";
      })
      .catch(err => {
        showToast(err.message, 'error');
      });
    })
    .catch(err => {
      showToast(err.message, 'error');
    });
}

// Load messages in real-time
function loadMessages() {
  getMessages()
    .then(messages => {
      chatWindow.innerHTML = "";
      
      messages.forEach(message => {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        
        const metaDiv = document.createElement("div");
        metaDiv.className = "meta";
        metaDiv.textContent = `${message.sender_name || message.sender_email} - ${message.timestamp ? new Date(message.timestamp).toLocaleString() : 'Just now'}`;
        
        const textDiv = document.createElement("div");
        textDiv.textContent = message.text;
        
        messageDiv.appendChild(metaDiv);
        messageDiv.appendChild(textDiv);
        chatWindow.appendChild(messageDiv);
      });
      
      // Scroll to bottom
      chatWindow.scrollTop = chatWindow.scrollHeight;
    })
    .catch(err => {
      console.error("Error loading messages:", err);
    });
}

// Set up real-time subscription for messages
supabase
  .from('messages')
  .on('INSERT', payload => {
    loadMessages(); // Reload messages when new ones are added
  })
  .subscribe();

// --- Profile System ---
const saveProfileBtn = document.getElementById("saveProfileBtn");
const profilePicInput = document.getElementById("profilePicInput");
const profilePic = document.getElementById("profilePic");
const profileName = document.getElementById("profileName");
const profileGrade = document.getElementById("profileGrade");
const profileBio = document.getElementById("profileBio");

saveProfileBtn.addEventListener("click", saveProfile);
profilePicInput.addEventListener("change", handleProfilePicUpload);

function handleProfilePicUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const user = supabase.auth.user();
  if (!user) {
    showToast('Please log in to update profile', 'error');
    return;
  }
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    profilePic.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function saveProfile() {
  const user = supabase.auth.user();
  if (!user) {
    showToast('Please log in to save profile', 'error');
    return;
  }
  
  const name = profileName.value;
  const grade = profileGrade.value;
  const bio = profileBio.value;
  const file = profilePicInput.files[0];
  
  saveProfileBtn.setAttribute('data-original-text', saveProfileBtn.textContent);
  setLoading(saveProfileBtn, true);
  
  let uploadPromise = Promise.resolve(null);
  
  // Upload image if selected (Note: Supabase Storage implementation would go here)
  if (file) {
    showToast('File upload not implemented in this demo', 'warning');
  }
  
  uploadPromise
    .then(photoURL => {
      const profileData = {
        name: name,
        grade: grade,
        bio: bio,
        updated_at: new Date().toISOString()
      };
      
      if (photoURL) {
        profileData.photo_url = photoURL;
      }
      
      // Update profile
      return updateProfile(user.id, profileData);
    })
    .then(() => {
      showToast("Profile saved successfully!");
      loadProfile();
    })
    .catch(err => {
      showToast(err.message, 'error');
    })
    .finally(() => {
      setLoading(saveProfileBtn, false);
    });
}

function loadProfile() {
  const user = supabase.auth.user();
  if (!user) return;
  
  getProfile(user.id)
    .then(profile => {
      if (profile) {
        profileName.value = profile.name || "";
        profileGrade.value = profile.grade || "";
        profileBio.value = profile.bio || "";
        if (profile.photo_url) {
          profilePic.src = profile.photo_url;
        }
      }
    })
    .catch(err => {
      console.error("Error loading profile:", err);
    });
}

// --- Auth buttons ---
document.getElementById("modalRegister").addEventListener("click", () => {
  const firstName = document.getElementById("modalFirstName").value;
  const lastName = document.getElementById("modalLastName").value;
  const email = document.getElementById("modalEmail").value;
  const pass = document.getElementById("modalPass").value;
  const grade = document.getElementById("modalGrade").value;
  const profilePicFile = document.getElementById("modalProfilePic").files[0];
  
  if (!firstName || !lastName || !email || !pass || !grade) {
    showToast('Please fill in all fields', 'error');
    return;
  }
  
  const button = document.getElementById("modalRegister");
  button.setAttribute('data-original-text', button.textContent);
  setLoading(button, true);
  
  supabase.auth.signUp({
    email: email,
    password: pass,
    options: {
      data: {
        first_name: firstName,
        last_name: lastName,
        name: `${firstName} ${lastName}`,
        grade: grade
      }
    }
  })
  .then(({ user, error }) => {
    if (error) throw error;
    
    // Store user profile and role
    const profileData = {
      first_name: firstName,
      last_name: lastName,
      name: `${firstName} ${lastName}`,
      email: email,
      grade: grade,
      created_at: new Date().toISOString()
    };
    
    // Set default role as student
    const userData = {
      id: user.id,
      email: email,
      name: `${firstName} ${lastName}`,
      role: 'student', // Default role
      created_at: new Date().toISOString()
    };
    
    // Create user profile and user record
    return Promise.all([
      createProfile(user.id, profileData),
      createUser(userData)
    ]);
  })
  .then(() => {
    showToast("Registered successfully! Please check your email for verification.");
    authModal.style.display="none";
    // Clear form
    document.getElementById("modalFirstName").value = "";
    document.getElementById("modalLastName").value = "";
    document.getElementById("modalEmail").value = "";
    document.getElementById("modalPass").value = "";
    document.getElementById("modalGrade").value = "";
    document.getElementById("modalProfilePic").value = "";
  })
  .catch(err => {
    showToast(err.message, 'error');
  })
  .finally(() => {
    setLoading(button, false);
  });
});

document.getElementById("modalLogin").addEventListener("click", () => {
  const email = document.getElementById("modalEmail").value;
  const pass = document.getElementById("modalPass").value;
  const button = document.getElementById("modalLogin");
  
  if (!email || !pass) {
    showToast('Please enter both email and password', 'error');
    return;
  }
  
  button.setAttribute('data-original-text', button.textContent);
  setLoading(button, true);
  
  supabase.auth.signInWithPassword({
    email: email,
    password: pass
  })
  .then(({ error }) => {
    if (error) throw error;
    showToast("Logged in successfully!");
    authModal.style.display="none"; 
  })
  .catch(err => {
    showToast(err.message, 'error');
  })
  .finally(() => {
    setLoading(button, false);
  });
});

document.getElementById("sidebarLogout").addEventListener("click", () => {
  supabase.auth.signOut().then(() => showToast("Logged out successfully!"));
});

// --- Auth state listener ---
supabase.auth.onAuthStateChange((event, session) => {
  const sideName = document.getElementById("sideName");
  const sideRole = document.getElementById("sideRole");
  const welcomeText = document.getElementById("welcomeText");
  const welcomeSub = document.getElementById("welcomeSub");
  const loginBtn = document.getElementById("openLogin");
  const logoutBtn = document.getElementById("sidebarLogout");
  const adminNav = document.getElementById("adminNav");
  const createClubBtn = document.getElementById("createClubBtn");
  const conversationsNav = document.getElementById("conversationsNav");

  if(session?.user){
    const user = session.user;
    
    // Load user data to get role
    getUserRole(user.id)
      .then(role => {
        const name = user.user_metadata?.name || user.email;
        
        sideName.textContent = name;
        welcomeText.textContent = `Welcome, ${name}`;
        
        // Set role display
        let roleDisplay = '';
        switch(role) {
          case 'admin':
            roleDisplay = 'Administrator';
            break;
          case 'leader':
            roleDisplay = 'Club Leader';
            break;
          case 'owner':
            roleDisplay = 'System Owner';
            break;
          default:
            roleDisplay = 'Student';
        }
        
        sideRole.textContent = roleDisplay;
        welcomeSub.textContent = roleDisplay + ' Dashboard';
        
        // Show/hide admin features based on role
        const isAdmin = role === 'admin' || role === 'owner';
        if (isAdmin) {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'block';
          });
          createClubBtn.style.display = "block";
          loadMessages(); // Load messages for admin
        } else {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'none';
          });
          createClubBtn.style.display = "none";
          
          // If on admin page, redirect to dashboard
          if (document.getElementById('admin').style.display === 'block') {
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('admin').style.display = 'none';
            document.querySelector('.nav-item.active').classList.remove('active');
            document.querySelector('[data-tab="dashboard"]').classList.add('active');
          }
        }
      })
      .catch(err => {
        console.error("Error loading user data:", err);
        sideName.textContent = user.email;
        welcomeText.textContent = `Welcome, ${user.email}`;
        sideRole.textContent = "Student";
        welcomeSub.textContent = "Ready to learn!";
      });
    
    loginBtn.style.display = "none";
    logoutBtn.style.display = "block";
    
    // Load user profile
    loadProfile();
    
    // Load user's clubs
    loadUserClubs();
  } else {
    sideName.textContent = "Guest";
    sideRole.textContent = "Not signed in";
    welcomeText.textContent = "Welcome";
    welcomeSub.textContent = "Please sign in";
    loginBtn.style.display = "block";
    logoutBtn.style.display = "none";
    
    // Hide admin features
    document.querySelectorAll('.admin-only').forEach(el => {
      el.style.display = 'none';
    });
    
    // Remove club tabs
    document.querySelectorAll('.club-tab').forEach(tab => tab.remove());
    document.querySelectorAll('.club-section').forEach(section => section.remove());
  }
});

// --- Clubs System ---
function loadUserClubs() {
  const user = supabase.auth.user();
  if (!user) return;
  
  // Load all clubs
  getClubs()
    .then(clubs => {
      const clubsList = document.getElementById("clubsList");
      clubsList.innerHTML = "";
      
      if (!clubs || clubs.length === 0) {
        clubsList.innerHTML = "<div class='list-item'>No clubs yet. Admins can create clubs.</div>";
        return;
      }
      
      clubs.forEach(club => {
        const div = document.createElement("div");
        div.className = "club-card";
        
        const isMember = club.members && club.members.includes(user.id);
        
        div.innerHTML = `
          <div class="club-header">
            ${club.logo_url ? `<img src="${club.logo_url}" class="club-logo" alt="${club.name} Logo">` : '<div class="club-logo" style="background:#e2e8f0;display:flex;align-items:center;justify-content:center;"><span class="material-symbols-outlined">groups</span></div>'}
            <div class="club-info">
              <h3 class="club-name">${club.name}</h3>
              <p class="club-abbr">${club.abbreviation}</p>
              <p class="club-leaders">Leaders: ${club.leader1}${club.leader2 ? `, ${club.leader2}` : ''}</p>
              <p>${club.description}</p>
            </div>
          </div>
          <div class="club-stats">
            <div class="club-stat">
              <div class="club-stat-value">${club.member_count || 1}</div>
              <div class="club-stat-label">Members</div>
            </div>
            <div class="club-stat">
              <div class="club-stat-value">${club.funds || 0} DH</div>
              <div class="club-stat-label">Funds</div>
            </div>
            <div class="club-stat">
              <div class="club-stat-value">${club.projects ? club.projects.length : 0}</div>
              <div class="club-stat-label">Projects</div>
            </div>
          </div>
          <div style="margin-top:12px;">
            ${isMember ? 
              '<button class="btn success" style="font-size: 12px; padding: 6px 12px;">Already Joined</button>' : 
              `<button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="joinClub('${club.id}')">Join Club</button>`
            }
          </div>
        `;
        clubsList.appendChild(div);
        
        // If user is a member, create a tab for this club
        if (isMember) {
          createClubTab(club.id, club);
        }
      });
    })
    .catch(err => {
      console.error("Error loading clubs:", err);
    });
}

function createClubTab(clubId, clubData) {
  // Check if tab already exists
  if (document.querySelector(`[data-tab="club-${clubId}"]`)) return;
  
  // Create tab in sidebar
  const sidebarNav = document.querySelector('.sidebar-nav');
  const clubTab = document.createElement('div');
  clubTab.className = 'nav-item club-tab';
  clubTab.dataset.tab = `club-${clubId}`;
  clubTab.innerHTML = `
    <span class="material-symbols-outlined icon">groups</span>${clubData.abbreviation}
  `;
  
  // Add click event
  clubTab.addEventListener('click', () => {
    document.querySelectorAll("section").forEach(sec => sec.style.display = "none");
    document.getElementById(`club-${clubId}`).style.display = "block";
    navItems.forEach(i => i.classList.remove("active"));
    clubTab.classList.add("active");
  });
  
  sidebarNav.appendChild(clubTab);
  
  // Create club section
  const main = document.querySelector('.main');
  const clubSection = document.createElement('section');
  clubSection.id = `club-${clubId}`;
  clubSection.className = 'card';
  clubSection.style.display = 'none';
  
  clubSection.innerHTML = `
    <div class="club-tab-content">
      <div class="club-header">
        ${clubData.logo_url ? `<img src="${clubData.logo_url}" class="club-logo" alt="${clubData.name} Logo">` : '<div class="club-logo" style="background:#e2e8f0;display:flex;align-items:center;justify-content:center;"><span class="material-symbols-outlined">groups</span></div>'}
        <div class="club-info">
          <h3>${clubData.name} (${clubData.abbreviation})</h3>
          <p class="club-leaders">Leaders: ${clubData.leader1}${clubData.leader2 ? `, ${clubData.leader2}` : ''}</p>
          <p>${clubData.description}</p>
        </div>
      </div>
      
      <div class="club-section">
        <h4><span class="material-symbols-outlined">account_balance</span>Club Funds</h4>
        <div class="funds-display">${clubData.funds || 0} DH</div>
        <p>Current available funds for club activities and projects.</p>
      </div>
      
      <div class="club-section">
        <h4><span class="material-symbols-outlined">work</span>W.I.P Projects</h4>
        <div id="club-projects-${clubId}">
          ${clubData.projects && clubData.projects.length > 0 ? 
            clubData.projects.map(project => `
              <div class="project-item">
                <h5 class="project-title">${project.title}</h5>
                <p class="project-desc">${project.description}</p>
                <small>Status: ${project.status || 'In Progress'}</small>
              </div>
            `).join('') : 
            '<p>No projects currently in progress.</p>'
          }
        </div>
      </div>
      
      <div class="club-section">
        <h4><span class="material-symbols-outlined">groups</span>Members</h4>
        <p>Total Members: ${clubData.member_count || 1}</p>
        <!-- Member list would go here -->
      </div>
    </div>
  `;
  
  main.appendChild(clubSection);
}

function joinClub(clubId) {
  const user = supabase.auth.user();
  if (!user) {
    showToast('Please log in to join clubs', 'error');
    return;
  }
  
  getClub(clubId)
    .then(club => {
      if (!club) {
        showToast('Club not found', 'error');
        return;
      }
      
      const members = club.members || [];
      
      if (members.includes(user.id)) {
        showToast('You are already a member of this club', 'error');
        return;
      }
      
      members.push(user.id);
      
      return updateClub(clubId, {
        members: members,
        member_count: members.length
      });
    })
    .then(() => {
      showToast('Successfully joined the club!');
    })
    .catch(err => {
      showToast(err.message, 'error');
    });
}

// --- Projects System ---
function loadProjects() {
  getProjects()
    .then(projects => {
      const projectsList = document.getElementById("projectsList");
      projectsList.innerHTML = "";
      
      if (!projects || projects.length === 0) {
        projectsList.innerHTML = "<div class='list-item'>No projects yet. Create one to get started!</div>";
        return;
      }
      
      projects.forEach(project => {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div>
            <strong>${project.title}</strong>
            <div style="font-size: 14px; color: var(--muted);">${project.description}</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Created by: ${project.creator_email}</div>
          </div>
          <div style="font-size: 12px; color: var(--muted);">${project.created_at ? new Date(project.created_at).toLocaleDateString() : 'Recently'}</div>
        `;
        projectsList.appendChild(div);
      });
    })
    .catch(err => {
      console.error("Error loading projects:", err);
    });
}

// Set up real-time subscription for projects
supabase
  .from('projects')
  .on('INSERT', payload => {
    loadProjects(); // Reload projects when new ones are added
  })
  .subscribe();

// --- Placeholder for other sections (assignments, events, etc.) ---
const placeholders = ["assignmentsList","eventsList","reportsList"];
placeholders.forEach(id => {
  const container = document.getElementById(id);
  if(container) container.innerHTML = "<div class='list-item'>No data yet</div>";
});

// --- Admin Panel Functions ---
function loadUsersForAdmin() {
  const adminContent = document.getElementById("adminContent");
  
  getUsers()
    .then(users => {
      let html = `
        <h4>User Management</h4>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Grade</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      if (!users || users.length === 0) {
        html += `<tr><td colspan="5">No users found</td></tr>`;
      } else {
        users.forEach(user => {
          let roleClass = '';
          switch(user.role) {
            case 'admin': roleClass = 'role-admin'; break;
            case 'leader': roleClass = 'role-leader'; break;
            case 'owner': roleClass = 'role-owner'; break;
            default: roleClass = 'role-student';
          }
          
          html += `
            <tr>
              <td>${user.name || 'N/A'}</td>
              <td>${user.email}</td>
              <td>${user.grade || '-'}</td>
              <td><span class="role-badge ${roleClass}">${user.role || 'student'}</span></td>
              <td>
                <button class="btn" style="padding: 4px 8px; font-size: 12px;" onclick="openRoleModal('${user.id}', '${user.name || user.email}', '${user.role || 'student'}')">Change Role</button>
              </td>
            </tr>
          `;
        });
      }
      
      html += `</tbody></table>`;
      adminContent.innerHTML = html;
    })
    .catch(err => {
      adminContent.innerHTML = `<p>Error loading users: ${err.message}</p>`;
    });
}

function openRoleModal(userId, userName, currentRole) {
  currentRoleUser = {
    id: userId,
    name: userName,
    currentRole: currentRole
  };
  
  document.getElementById('roleUserInfo').innerHTML = `
    <p><strong>User:</strong> ${userName}</p>
    <p><strong>Current Role:</strong> ${currentRole}</p>
  `;
  
  // Set the current role as selected
  document.querySelectorAll('.role-option').forEach(option => {
    option.classList.remove('selected');
    const input = option.querySelector('input');
    if (input.value === currentRole) {
      option.classList.add('selected');
      input.checked = true;
    }
  });
  
  roleModal.style.display = 'flex';
}

document.getElementById("manageUsersBtn").addEventListener("click", () => {
  loadUsersForAdmin();
});

document.getElementById("systemStatsBtn").addEventListener("click", () => {
  const adminContent = document.getElementById("adminContent");
  
  // Get counts from all collections
  Promise.all([
    getUsers(),
    getProjects(),
    getClubs(),
    getMessages()
  ])
  .then(([users, projects, clubs, messages]) => {
    adminContent.innerHTML = `
      <h4>System Statistics</h4>
      <div class="grid">
        <div class="card">
          <h4>Total Users</h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0;">${users?.length || 0}</p>
        </div>
        <div class="card">
          <h4>Active Projects</h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0;">${projects?.length || 0}</p>
        </div>
        <div class="card">
          <h4>Clubs</h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0;">${clubs?.length || 0}</p>
        </div>
        <div class="card">
          <h4>Messages</h4>
          <p style="font-size: 24px; font-weight: bold; margin: 0;">${messages?.length || 0}</p>
        </div>
      </div>
    `;
  })
  .catch(err => {
    adminContent.innerHTML = `<p>Error loading statistics: ${err.message}</p>`;
  });
});

document.getElementById("manageRolesBtn").addEventListener("click", () => {
  loadUsersForAdmin();
});

// --- Supabase Database Functions ---

// User functions
async function getUsers() {
  const { data, error } = await supabase
    .from('users')
    .select('*');
  
  if (error) throw error;
  return data;
}

async function createUser(userData) {
  const { data, error } = await supabase
    .from('users')
    .insert([userData]);
  
  if (error) throw error;
  return data;
}

async function updateUserRole(userId, role) {
  const { data, error } = await supabase
    .from('users')
    .update({ role: role, updated_at: new Date().toISOString() })
    .eq('id', userId);
  
  if (error) throw error;
  return data;
}

async function getUserRole(userId) {
  const { data, error } = await supabase
    .from('users')
    .select('role')
    .eq('id', userId)
    .single();
  
  if (error) throw error;
  return data?.role || 'student';
}

// Profile functions
async function getProfile(userId) {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', userId)
    .single();
  
  if (error && error.code !== 'PGRST116') throw error; // PGRST116 is "not found"
  return data;
}

async function createProfile(userId, profileData) {
  const { data, error } = await supabase
    .from('profiles')
    .insert([{ id: userId, ...profileData }]);
  
  if (error) throw error;
  return data;
}

async function updateProfile(userId, profileData) {
  const { data, error } = await supabase
    .from('profiles')
    .update(profileData)
    .eq('id', userId);
  
  if (error) throw error;
  return data;
}

// Project functions
async function getProjects() {
  const { data, error } = await supabase
    .from('projects')
    .select('*')
    .order('created_at', { ascending: false });
  
  if (error) throw error;
  return data;
}

async function createProject(projectData) {
  const { data, error } = await supabase
    .from('projects')
    .insert([projectData]);
  
  if (error) throw error;
  return data;
}

// Club functions
async function getClubs() {
  const { data, error } = await supabase
    .from('clubs')
    .select('*');
  
  if (error) throw error;
  return data;
}

async function getClub(clubId) {
  const { data, error } = await supabase
    .from('clubs')
    .select('*')
    .eq('id', clubId)
    .single();
  
  if (error) throw error;
  return data;
}

async function createClub(clubData) {
  const { data, error } = await supabase
    .from('clubs')
    .insert([clubData]);
  
  if (error) throw error;
  return data;
}

async function updateClub(clubId, clubData) {
  const { data, error } = await supabase
    .from('clubs')
    .update(clubData)
    .eq('id', clubId);
  
  if (error) throw error;
  return data;
}

// Message functions
async function getMessages() {
  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .order('timestamp', { ascending: true });
  
  if (error) throw error;
  return data;
}

async function createMessage(messageData) {
  const { data, error } = await supabase
    .from('messages')
    .insert([messageData]);
  
  if (error) throw error;
  return data;
}

// Initialize the system
window.addEventListener('load', () => {
  // Load initial data
  loadProjects();
});
</script>
</body>
</html>
